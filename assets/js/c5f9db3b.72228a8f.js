"use strict";(self.webpackChunksummary=self.webpackChunksummary||[]).push([["5658"],{67516:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>l,toc:()=>i,default:()=>m,metadata:()=>a,assets:()=>c,contentTitle:()=>s});var a=JSON.parse('{"id":"background/Java/concurrent-and-jvm/Java Concurrent Cases","title":"Java \u5E76\u53D1\u7F16\u7A0B","description":"Executor \u5E76\u53D1\u6267\u884C\u4EFB\u52A1","source":"@site/docs/01-background/01-Java/04-concurrent-and-jvm/07-Java Concurrent Cases.mdx","sourceDirName":"01-background/01-Java/04-concurrent-and-jvm","slug":"/background/Java/concurrent-and-jvm/Java Concurrent Cases","permalink":"/summary/background/Java/concurrent-and-jvm/Java Concurrent Cases","draft":false,"unlisted":false,"editUrl":"https://github.com/Halcyon666/summary/edit/main/docs/01-background/01-Java/04-concurrent-and-jvm/07-Java Concurrent Cases.mdx","tags":[],"version":"current","lastUpdatedBy":"Halcyon666","lastUpdatedAt":1768750754000,"sidebarPosition":7,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"JAVA\u865A\u62DF\u673A","permalink":"/summary/background/Java/concurrent-and-jvm/JAVA Virtual Machine"},"next":{"title":"Oracle\u76F8\u5173\u95EE\u9898\u5904\u7406","permalink":"/summary/background/Java/problem-summary/Oracle"}}'),r=n(35656),u=n(40059),o=n(60145);let l={},s="Java \u5E76\u53D1\u7F16\u7A0B",c={},i=[{value:"Executor \u5E76\u53D1\u6267\u884C\u4EFB\u52A1",id:"executor-\u5E76\u53D1\u6267\u884C\u4EFB\u52A1",level:2}];function p(e){let t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,u.R)(),...e.components},{Details:n}=t;return n||function(e,t){throw Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"java-\u5E76\u53D1\u7F16\u7A0B",children:"Java \u5E76\u53D1\u7F16\u7A0B"})}),"\n",(0,r.jsx)(t.h2,{id:"executor-\u5E76\u53D1\u6267\u884C\u4EFB\u52A1",children:"Executor \u5E76\u53D1\u6267\u884C\u4EFB\u52A1"}),"\n",(0,r.jsx)(t.p,{children:"Using Executor and CompletableFuture to concurrent execute the Many Queries. Below is commit changes."}),"\n",(0,r.jsxs)(n,{children:[(0,r.jsx)("summary",{children:"Java \u5E76\u53D1\u7F16\u7A0B\u6848\u4F8B\uFF1A\u4EFB\u52A1\u5931\u8D25\u5FEB\u901F\u5931\u8D25\u53D6\u6D88\u5176\u4ED6\u4EFB\u52A1"}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:"setLineNumbers",children:'package com.whalefall541.cases.concurrentqry.jobversion;\n\nimport lombok.extern.slf4j.Slf4j;\n\nimport java.util.List;\nimport java.util.concurrent.*;\nimport java.util.concurrent.atomic.AtomicBoolean;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\n@SuppressWarnings("all")\n@Slf4j\npublic class JobFailFastAsyncExecutor implements AutoCloseable {\n\n    private final ExecutorService executor;\n\n    public JobFailFastAsyncExecutor(int threadCount, String jobName) {\n        this.executor = Executors.newFixedThreadPool(threadCount, r -> {\n            Thread thread = new Thread(r);\n            thread.setName(String.format("%s-%s", jobName, thread.getName()));\n            return thread;\n        });\n    }\n\n    /**\n     * \u6267\u884C\u4E00\u7EC4\u5F02\u6B65\u4EFB\u52A1\uFF0C\u4E00\u65E6\u5176\u4E2D\u4EFB\u4E00\u4EFB\u52A1\u5931\u8D25\uFF0C\u7ACB\u5373\u53D6\u6D88\u6240\u6709\u4EFB\u52A1\uFF0C\u5E76\u4F20\u64AD\u5F02\u5E38 <br/>\n     * \u771F\u6B63\u4E25\u683C\u610F\u4E49\u7684\u201Cfail-fast + \u6700\u5C11\u65E5\u5FD7\n     *\n     * @param inputs       \u8F93\u5165\u53C2\u6570\u5217\u8868\n     * @param taskFunction \u4EFB\u52A1\u5904\u7406\u51FD\u6570\uFF0C\u8F93\u5165 P \u8FD4\u56DE R\n     * @return \u4E00\u4E2A\u5F02\u6B65 CompletableFuture\uFF0C\u6210\u529F\u8FD4\u56DE\u7ED3\u679C\u5217\u8868\uFF0C\u5931\u8D25\u629B\u51FA\u7B2C\u4E00\u4E2A\u5F02\u5E38\n     */\n    public <P, R> CompletableFuture<List<R>> executeFailFast(List<P> inputs, Function<P, R> taskFunction) {\n        List<CompletableFuture<R>> futures = inputs.stream()\n                .map(input -> CompletableFuture.supplyAsync(\n                        // \u5F02\u6B65\u7EBF\u7A0B\uFF08\u6765\u81EA thread pool\uFF09\u6267\u884C\u4E0B\u9762\u903B\u8F91\n                        () -> taskFunction.apply(input), executor))\n                .collect(Collectors.toList());\n        CompletableFuture<List<R>> resultFuture = new CompletableFuture<>();\n        CommonTaskSupport.registerFailFastHandlers(futures, resultFuture);\n        CommonTaskSupport.collectAllResults(futures, resultFuture);\n        return resultFuture;\n    }\n\n    static class CommonTaskSupport {\n        private CommonTaskSupport() {\n        }\n\n        public static <R> void registerFailFastHandlers(List<CompletableFuture<R>> futures,\n                                                        CompletableFuture<List<R>> resultFuture) {\n            AtomicBoolean failFastTriggered = new AtomicBoolean(false);\n            futures.forEach(future -> future.whenComplete(\n                    // \u4E0B\u9762\u90FD\u662F\u7684\u5F02\u6B65\u7EBF\u7A0B\u5B8C\u6210\u540E\u89E6\u53D1\n                    (r, ex) -> {\n                        if (ex != null && failFastTriggered.compareAndSet(false, true)) {\n                            Throwable actual = unwrap(ex);\n                            logIfNeeded(actual);\n                            resultFuture.completeExceptionally(actual);\n                            futures.forEach(f -> {\n                                boolean cancelled = f.cancel(true);\n                                log.debug("\u5C1D\u8BD5\u53D6\u6D88\u4EFB\u52A1{}: {}", f, cancelled ? "\u6210\u529F" : "\u5931\u8D25");\n                            });\n                        }\n                    }));\n        }\n\n        private static Throwable unwrap(Throwable ex) {\n            if (ex instanceof CompletionException || ex instanceof ExecutionException) {\n                return ex.getCause();\n            }\n            return ex;\n        }\n\n        /**\n         * \u4F18\u96C5\u5173\u95ED\u7EBF\u7A0B\u6C60\n         *\n         * @param executor \u7EBF\u7A0B\u6C60\n         */\n        public static void shutdownGracefully(ExecutorService executor) {\n            executor.shutdown();\n            try {\n                if (!executor.awaitTermination(1, TimeUnit.MINUTES)) {\n                    executor.shutdownNow();\n                }\n            } catch (InterruptedException e) {\n                executor.shutdownNow();\n                Thread.currentThread().interrupt();\n            }\n        }\n\n        private static void logIfNeeded(Throwable actual) {\n            if (!(actual instanceof CancellationException)) {\n                log.warn("\u4EFB\u52A1\u5931\u8D25\uFF0C\u5F00\u59CB fail-fast \u53D6\u6D88\u5176\u4ED6\u4EFB\u52A1\uFF1A{} - [{}]",\n                        actual != null ? actual.getMessage() : "null",\n                        actual != null ? actual.getClass().getSimpleName() : "null");\n            }\n        }\n\n        public static <R> void collectAllResults(List<CompletableFuture<R>> futures,\n                                                 CompletableFuture<List<R>> resultFuture) {\n            CompletableFuture\n                    .allOf(futures.toArray(new CompletableFuture[0]))\n                    .whenComplete((v, ex) -> {\n                        if (!resultFuture.isDone()) {\n                            try {\n                                List<R> results = futures.stream()\n                                        .map(CompletableFuture::join)\n                                        .collect(Collectors.toList());\n                                resultFuture.complete(results);\n                            } catch (CompletionException e) {\n                                resultFuture.completeExceptionally(e.getCause());\n                            }\n                        }\n                    });\n        }\n    }\n\n\n    @Override\n    public void close() {\n        CommonTaskSupport.shutdownGracefully(executor);\n    }\n\n}\n\n'})})]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.a,{href:"https://github.com/Halcyon666/mybatis-plus/tree/purebranch/src/main/java/com/whalefall541/cases/concurrentqry",children:"\u8BE6\u7EC6\u4EE3\u7801\u63D0\u4EA4\u8BB0\u5F55"})}),"\n","\n",(0,r.jsx)(o.A,{})]})}function m(e={}){let{wrapper:t}={...(0,u.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}}}]);
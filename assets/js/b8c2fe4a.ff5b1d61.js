"use strict";(self.webpackChunksummary=self.webpackChunksummary||[]).push([["9477"],{64342:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>s,toc:()=>t,default:()=>p,metadata:()=>a,assets:()=>i,contentTitle:()=>l});var a=JSON.parse('{"id":"background/Java/JavaBase/trace","title":"Jaeger Trace MDC","description":"Simple Demo Code","source":"@site/docs/background/Java/JavaBase/trace.mdx","sourceDirName":"background/Java/JavaBase","slug":"/background/Java/JavaBase/trace","permalink":"/summary/background/Java/JavaBase/trace","draft":false,"unlisted":false,"editUrl":"https://github.com/Halcyon666/summary/edit/main/docs/background/Java/JavaBase/trace.mdx","tags":[],"version":"current","lastUpdatedBy":"Halcyon666","lastUpdatedAt":1769326576000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"netty","permalink":"/summary/background/Java/JavaBase/netty"},"next":{"title":"\u{1F4BC} Interview Cases","permalink":"/summary/category/-interview-cases"}}'),c=r(35656),d=r(40059);let s={},l="Jaeger Trace MDC",i={},t=[{value:"1. \u65B9\u6848\u6982\u8FF0",id:"1-\u65B9\u6848\u6982\u8FF0",level:2},{value:"1.1 \u80CC\u666F\u4E0E\u76EE\u6807",id:"11-\u80CC\u666F\u4E0E\u76EE\u6807",level:3},{value:"1.2 \u6838\u5FC3\u4EF7\u503C",id:"12-\u6838\u5FC3\u4EF7\u503C",level:3},{value:"2. \u67B6\u6784\u8BBE\u8BA1",id:"2-\u67B6\u6784\u8BBE\u8BA1",level:2},{value:"2.1 \u6574\u4F53\u67B6\u6784\u56FE",id:"21-\u6574\u4F53\u67B6\u6784\u56FE",level:3},{value:"2.2 \u6838\u5FC3\u7EC4\u4EF6\u8BF4\u660E",id:"22-\u6838\u5FC3\u7EC4\u4EF6\u8BF4\u660E",level:3},{value:"2.2.1 CustomMDCScopeManager",id:"221-custommdcscopemanager",level:4},{value:"2.2.2 CustomMDCScope",id:"222-custommdcscope",level:4},{value:"3. \u5173\u952E\u6D41\u7A0B\u8BBE\u8BA1",id:"3-\u5173\u952E\u6D41\u7A0B\u8BBE\u8BA1",level:2},{value:"3.1 \u63A5\u6536\u8FDC\u7A0B Trace \u4E0A\u4E0B\u6587\u7684\u6D41\u7A0B",id:"31-\u63A5\u6536\u8FDC\u7A0B-trace-\u4E0A\u4E0B\u6587\u7684\u6D41\u7A0B",level:3},{value:"3.2 \u5D4C\u5957 Span \u7684 MDC \u7BA1\u7406\u6D41\u7A0B",id:"32-\u5D4C\u5957-span-\u7684-mdc-\u7BA1\u7406\u6D41\u7A0B",level:3},{value:"3.3 Trace ID \u5206\u5272\u7B97\u6CD5",id:"33-trace-id-\u5206\u5272\u7B97\u6CD5",level:3},{value:"4. \u914D\u7F6E\u4E0E\u96C6\u6210",id:"4-\u914D\u7F6E\u4E0E\u96C6\u6210",level:2},{value:"4.1 Tracer \u521D\u59CB\u5316\u914D\u7F6E",id:"41-tracer-\u521D\u59CB\u5316\u914D\u7F6E",level:3},{value:"4.2 Logback \u914D\u7F6E",id:"42-logback-\u914D\u7F6E",level:3},{value:"4.3 Spring Boot \u96C6\u6210\uFF08\u53EF\u9009\uFF09",id:"43-spring-boot-\u96C6\u6210\u53EF\u9009",level:3},{value:"5. \u4F7F\u7528\u573A\u666F\u4E0E\u6700\u4F73\u5B9E\u8DF5",id:"5-\u4F7F\u7528\u573A\u666F\u4E0E\u6700\u4F73\u5B9E\u8DF5",level:2},{value:"5.1 \u63A5\u6536\u4E0A\u6E38 Trace \u4E0A\u4E0B\u6587",id:"51-\u63A5\u6536\u4E0A\u6E38-trace-\u4E0A\u4E0B\u6587",level:3},{value:"5.2 \u5411\u4E0B\u6E38\u4F20\u9012 Trace \u4E0A\u4E0B\u6587",id:"52-\u5411\u4E0B\u6E38\u4F20\u9012-trace-\u4E0A\u4E0B\u6587",level:3},{value:"5.3 \u5F02\u6B65\u573A\u666F\u5904\u7406",id:"53-\u5F02\u6B65\u573A\u666F\u5904\u7406",level:3},{value:"6. \u5173\u952E\u8BBE\u8BA1\u51B3\u7B56",id:"6-\u5173\u952E\u8BBE\u8BA1\u51B3\u7B56",level:2},{value:"6.1 \u4E3A\u4EC0\u4E48\u4E0D\u76F4\u63A5\u5728\u4E1A\u52A1\u4EE3\u7801\u4E2D\u64CD\u4F5C MDC\uFF1F",id:"61-\u4E3A\u4EC0\u4E48\u4E0D\u76F4\u63A5\u5728\u4E1A\u52A1\u4EE3\u7801\u4E2D\u64CD\u4F5C-mdc",level:3},{value:"6.2 \u4E3A\u4EC0\u4E48\u9700\u8981\u4FDD\u5B58 MDC \u5FEB\u7167\uFF1F",id:"62-\u4E3A\u4EC0\u4E48\u9700\u8981\u4FDD\u5B58-mdc-\u5FEB\u7167",level:3},{value:"6.3 \u4E3A\u4EC0\u4E48\u4F7F\u7528 ThreadLocal \u800C\u4E0D\u662F InheritableThreadLocal\uFF1F",id:"63-\u4E3A\u4EC0\u4E48\u4F7F\u7528-threadlocal-\u800C\u4E0D\u662F-inheritablethreadlocal",level:3},{value:"7. \u76D1\u63A7\u4E0E\u8C03\u8BD5",id:"7-\u76D1\u63A7\u4E0E\u8C03\u8BD5",level:2},{value:"7.1 \u65E5\u5FD7\u8F93\u51FA\u793A\u4F8B",id:"71-\u65E5\u5FD7\u8F93\u51FA\u793A\u4F8B",level:3},{value:"7.2 Jaeger UI \u67E5\u8BE2",id:"72-jaeger-ui-\u67E5\u8BE2",level:3},{value:"7.3 \u5E38\u89C1\u95EE\u9898\u6392\u67E5",id:"73-\u5E38\u89C1\u95EE\u9898\u6392\u67E5",level:3},{value:"8. \u6027\u80FD\u8003\u91CF",id:"8-\u6027\u80FD\u8003\u91CF",level:2},{value:"8.1 \u6027\u80FD\u5F71\u54CD\u5206\u6790",id:"81-\u6027\u80FD\u5F71\u54CD\u5206\u6790",level:3},{value:"8.2 \u4F18\u5316\u5EFA\u8BAE",id:"82-\u4F18\u5316\u5EFA\u8BAE",level:3},{value:"9. \u6269\u5C55\u65B9\u5411",id:"9-\u6269\u5C55\u65B9\u5411",level:2},{value:"9.1 \u652F\u6301\u54CD\u5E94\u5F0F\u7F16\u7A0B\uFF08Reactor/WebFlux\uFF09",id:"91-\u652F\u6301\u54CD\u5E94\u5F0F\u7F16\u7A0Breactorwebflux",level:3},{value:"9.2 \u96C6\u6210 Spring Cloud Sleuth",id:"92-\u96C6\u6210-spring-cloud-sleuth",level:3},{value:"9.3 \u652F\u6301 OpenTelemetry",id:"93-\u652F\u6301-opentelemetry",level:3},{value:"10. \u603B\u7ED3",id:"10-\u603B\u7ED3",level:2}];function o(e){let n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"jaeger-trace-mdc",children:"Jaeger Trace MDC"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.a,{href:"https://github.com/Halcyon666/learn-cases/tree/main/learncases/src/main/java/com/whalefall/learncases/tracer",children:"Simple Demo Code"})}),"\n",(0,c.jsx)(n.h2,{id:"1-\u65B9\u6848\u6982\u8FF0",children:"1. \u65B9\u6848\u6982\u8FF0"}),"\n",(0,c.jsx)(n.h3,{id:"11-\u80CC\u666F\u4E0E\u76EE\u6807",children:"1.1 \u80CC\u666F\u4E0E\u76EE\u6807"}),"\n",(0,c.jsx)(n.p,{children:"\u5728\u5206\u5E03\u5F0F\u7CFB\u7EDF\u4E2D\uFF0C\u8DE8\u670D\u52A1\u7684\u8BF7\u6C42\u94FE\u8DEF\u8FFD\u8E2A\u662F\u5B9A\u4F4D\u95EE\u9898\u7684\u5173\u952E\u624B\u6BB5\u3002\u672C\u65B9\u6848\u65E8\u5728\u5B9E\u73B0 Jaeger \u5206\u5E03\u5F0F\u8FFD\u8E2A\u4E0E SLF4J MDC\uFF08Mapped Diagnostic Context\uFF09\u7684\u6DF1\u5EA6\u96C6\u6210\uFF0C\u4F7F\u5F97\uFF1A"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\u65E5\u5FD7\u81EA\u52A8\u643A\u5E26 traceId/spanId\uFF0C\u4FBF\u4E8E\u65E5\u5FD7\u805A\u5408\u67E5\u8BE2"}),"\n",(0,c.jsx)(n.li,{children:"\u652F\u6301\u8DE8\u670D\u52A1\u7684 trace \u4E0A\u4E0B\u6587\u4F20\u9012"}),"\n",(0,c.jsx)(n.li,{children:"\u5728\u7EBF\u7A0B\u6C60\u7B49\u5F02\u6B65\u573A\u666F\u4E0B\u4FDD\u6301 trace \u4E0A\u4E0B\u6587\u7684\u51C6\u786E\u6027"}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"12-\u6838\u5FC3\u4EF7\u503C",children:"1.2 \u6838\u5FC3\u4EF7\u503C"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u95EE\u9898\u5B9A\u4F4D\u6548\u7387\u63D0\u5347"}),"\uFF1A\u901A\u8FC7 traceId \u5FEB\u901F\u5173\u8054\u5206\u5E03\u5F0F\u7CFB\u7EDF\u4E2D\u7684\u6240\u6709\u76F8\u5173\u65E5\u5FD7"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u96F6\u4FB5\u5165\u6027"}),"\uFF1A\u4E1A\u52A1\u4EE3\u7801\u65E0\u9700\u624B\u52A8\u7BA1\u7406 MDC\uFF0C\u81EA\u52A8\u6CE8\u5165\u548C\u6E05\u7406"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u7EBF\u7A0B\u5B89\u5168"}),"\uFF1A\u652F\u6301\u5D4C\u5957 Span \u548C\u7EBF\u7A0B\u6C60\u590D\u7528\u573A\u666F"]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"2-\u67B6\u6784\u8BBE\u8BA1",children:"2. \u67B6\u6784\u8BBE\u8BA1"}),"\n",(0,c.jsx)(n.h3,{id:"21-\u6574\u4F53\u67B6\u6784\u56FE",children:"2.1 \u6574\u4F53\u67B6\u6784\u56FE"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Application Layer                        \u2502\n\u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 Controller   \u2502\u2500\u2500\u2500>\u2502  Service     \u2502\u2500\u2500\u2500>\u2502   DAO        \u2502  \u2502\n\u2502  \u2502 (HTTP Entry) \u2502    \u2502 (Business)   \u2502    \u2502 (Database)   \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502         \u2502                    \u2502                    \u2502          \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502                              \u2502                                \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502          Tracing Layer       \u25BC                                \u2502\n\u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502     CustomMDCScopeManager (\u6838\u5FC3\u7EC4\u4EF6)          \u2502           \u2502\n\u2502  \u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502           \u2502\n\u2502  \u2502  \u2502  ThreadLocal<CustomMDCScope>        \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - \u7BA1\u7406 Scope \u751F\u547D\u5468\u671F              \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - \u7EF4\u62A4 Span \u6808                     \u2502     \u2502           \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502           \u2502\n\u2502  \u2502                                               \u2502           \u2502\n\u2502  \u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502           \u2502\n\u2502  \u2502  \u2502  CustomMDCScope (Scope \u5B9E\u73B0)        \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - MDC \u5FEB\u7167\u4E0E\u6062\u590D                   \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - \u652F\u6301\u5D4C\u5957 Span                    \u2502     \u2502           \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                              \u2502                                \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Logging Layer        \u25BC                                \u2502\n\u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502              SLF4J MDC                        \u2502           \u2502\n\u2502  \u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502           \u2502\n\u2502  \u2502  \u2502  traceId:  04bf92f3577b34da...      \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  spanId:   36bd32b7a5712a1a         \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  parentId: 00f067aa0ba902b7         \u2502     \u2502           \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                              \u2502                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u25BC\n                    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502  Jaeger Collector  \u2502\n                    \u2502  (Trace Storage)   \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,c.jsx)(n.h3,{id:"22-\u6838\u5FC3\u7EC4\u4EF6\u8BF4\u660E",children:"2.2 \u6838\u5FC3\u7EC4\u4EF6\u8BF4\u660E"}),"\n",(0,c.jsx)(n.h4,{id:"221-custommdcscopemanager",children:"2.2.1 CustomMDCScopeManager"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u804C\u8D23"}),"\uFF1A\u5B9E\u73B0 OpenTracing \u7684 ",(0,c.jsx)(n.code,{children:"ScopeManager"})," \u63A5\u53E3\uFF0C\u7BA1\u7406 Span \u7684\u6FC0\u6D3B\u4E0E\u4F20\u64AD"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u5173\u952E\u5B9E\u73B0"}),"\uFF1A"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:"private final ThreadLocal<CustomMDCScope> tlsScope = new ThreadLocal<>();\n\n@Override\npublic Scope activate(Span span) {\n    return new CustomMDCScope(span);\n}\n\n@Override\npublic Span activeSpan() {\n    CustomMDCScope scope = tlsScope.get();\n    return scope == null ? null : scope.wrapped;\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u8BBE\u8BA1\u8981\u70B9"}),"\uFF1A"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u4F7F\u7528 ",(0,c.jsx)(n.code,{children:"ThreadLocal"})," \u4FDD\u8BC1\u7EBF\u7A0B\u9694\u79BB"]}),"\n",(0,c.jsx)(n.li,{children:"\u652F\u6301 Scope \u7684\u5D4C\u5957\uFF08\u901A\u8FC7\u94FE\u8868\u7ED3\u6784\u7EF4\u62A4 previous\uFF09"}),"\n",(0,c.jsxs)(n.li,{children:["\u5B9E\u73B0\u61D2\u6FC0\u6D3B\uFF1A\u4EC5\u5728\u8C03\u7528 ",(0,c.jsx)(n.code,{children:"activate()"})," \u65F6\u624D\u6CE8\u5165 MDC"]}),"\n"]}),"\n",(0,c.jsx)(n.h4,{id:"222-custommdcscope",children:"2.2.2 CustomMDCScope"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u804C\u8D23"}),"\uFF1A\u5B9E\u73B0 OpenTracing \u7684 ",(0,c.jsx)(n.code,{children:"Scope"})," \u63A5\u53E3\uFF0C\u7BA1\u7406\u5355\u4E2A Span \u7684\u751F\u547D\u5468\u671F"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u6838\u5FC3\u673A\u5236"}),"\uFF1A\u5FEB\u7167-\u6CE8\u5165-\u6062\u590D\uFF08Snapshot-Inject-Restore\uFF09"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'CustomMDCScope(Span span) {\n    // 1. \u4FDD\u5B58\u5F53\u524D MDC \u5FEB\u7167\n    this.previousTraceId = MDC.get("traceId");\n    this.previousSpanId = MDC.get("spanId");\n    \n    // 2. \u5EFA\u7ACB\u94FE\u8868\u5173\u7CFB\uFF08\u652F\u6301\u5D4C\u5957\uFF09\n    this.previous = CustomMDCScopeManager.this.tlsScope.get();\n    CustomMDCScopeManager.this.tlsScope.set(this);\n    \n    // 3. \u6CE8\u5165\u65B0\u7684 trace \u4E0A\u4E0B\u6587\n    MDC.put("traceId", span.context().toTraceId());\n    MDC.put("spanId", span.context().toSpanId());\n}\n\n@Override\npublic void close() {\n    // 4. \u6062\u590D\u5230\u4E0A\u4E00\u5C42 Scope\n    CustomMDCScopeManager.this.tlsScope.set(previous);\n    \n    // 5. \u6062\u590D MDC \u5230\u5FEB\u7167\u72B6\u6001\n    restoreMDC("traceId", previousTraceId);\n    restoreMDC("spanId", previousSpanId);\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"3-\u5173\u952E\u6D41\u7A0B\u8BBE\u8BA1",children:"3. \u5173\u952E\u6D41\u7A0B\u8BBE\u8BA1"}),"\n",(0,c.jsx)(n.h3,{id:"31-\u63A5\u6536\u8FDC\u7A0B-trace-\u4E0A\u4E0B\u6587\u7684\u6D41\u7A0B",children:"3.1 \u63A5\u6536\u8FDC\u7A0B Trace \u4E0A\u4E0B\u6587\u7684\u6D41\u7A0B"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:'\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 HTTP Request\u2502\n\u2502  Headers    \u2502\n\u2502 uber-trace-id: 4bf92f3577b...\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. \u89E3\u6790 HTTP Header              \u2502\n\u2502    - \u63D0\u53D6 traceId (128-bit)      \u2502\n\u2502    - \u63D0\u53D6 parentSpanId (64-bit)  \u2502\n\u2502    - \u63D0\u53D6 flags (\u91C7\u6837\u6807\u8BB0)       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. \u6784\u9020 JaegerSpanContext        \u2502\n\u2502    long[] parts = splitTraceId() \u2502\n\u2502    new JaegerSpanContext(        \u2502\n\u2502      traceIdHigh,                \u2502\n\u2502      traceIdLow,                 \u2502\n\u2502      parentSpanId,               \u2502\n\u2502      parentOfParentId,           \u2502\n\u2502      flags                       \u2502\n\u2502    )                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. \u521B\u5EFA\u5B50 Span                   \u2502\n\u2502    tracer.buildSpan("child-span")\u2502\n\u2502          .asChildOf(parentContext)\u2502\n\u2502          .withTag(...)           \u2502\n\u2502          .start()                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. \u6FC0\u6D3B Span \u5230\u5F53\u524D\u7EBF\u7A0B          \u2502\n\u2502    try (Scope scope =            \u2502\n\u2502      tracer.scopeManager()       \u2502\n\u2502            .activate(childSpan)) \u2502\n\u2502    {                             \u2502\n\u2502      // MDC \u81EA\u52A8\u6CE8\u5165             \u2502\n\u2502      // \u4E1A\u52A1\u903B\u8F91\u6267\u884C             \u2502\n\u2502    } // MDC \u81EA\u52A8\u6E05\u7406             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,c.jsx)(n.h3,{id:"32-\u5D4C\u5957-span-\u7684-mdc-\u7BA1\u7406\u6D41\u7A0B",children:"3.2 \u5D4C\u5957 Span \u7684 MDC \u7BA1\u7406\u6D41\u7A0B"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:'\u65F6\u95F4\u7EBF \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\n\nThreadLocal Stack:\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  null                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nactivate(spanA)\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  ScopeA: {traceId: xxx, spanId: A, previous: null}\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nMDC: {traceId: xxx, spanId: A}\n\n  activate(spanB)  // \u5D4C\u5957\u8C03\u7528\n  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  ScopeB: {traceId: xxx, spanId: B, previous: ScopeA}\u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n  MDC: {traceId: xxx, spanId: B}  // spanId \u66F4\u65B0\n\n    // \u4E1A\u52A1\u4EE3\u7801\u6267\u884C\n    log.info("Processing...")  // \u65E5\u5FD7\u643A\u5E26 spanId=B\n\n  close(ScopeB)\n  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  ScopeA: {traceId: xxx, spanId: A, previous: null}\u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n  MDC: {traceId: xxx, spanId: A}  // \u6062\u590D\u5230 spanId=A\n\nclose(ScopeA)\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  null                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nMDC: {}  // \u5B8C\u5168\u6E05\u7A7A\n'})}),"\n",(0,c.jsx)(n.h3,{id:"33-trace-id-\u5206\u5272\u7B97\u6CD5",children:"3.3 Trace ID \u5206\u5272\u7B97\u6CD5"}),"\n",(0,c.jsxs)(n.p,{children:["Jaeger \u652F\u6301 128-bit \u7684 traceId\uFF0C\u4F46 Java ",(0,c.jsx)(n.code,{children:"long"})," \u4EC5\u4E3A 64-bit\uFF0C\u56E0\u6B64\u9700\u8981\u5206\u5272\uFF1A"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'/**\n * \u5C06\u5341\u516D\u8FDB\u5236 traceId \u5B57\u7B26\u4E32\u5206\u5272\u4E3A\u9AD864\u4F4D\u548C\u4F4E64\u4F4D\n * \n * \u793A\u4F8B:\n * \u8F93\u5165: "04bf92f3577b34da63ce929d0e0e4736" (32\u4E2A\u5341\u516D\u8FDB\u5236\u5B57\u7B26 = 128 bit)\n * \u8F93\u51FA: [0x04bf92f3577b34da, 0x63ce929d0e0e4736]\n */\npublic static long[] splitTraceId(String traceIdHex) {\n    if (traceIdHex.length() <= 16) {\n        // \u4EC5\u6709\u4F4E64\u4F4D\uFF0C\u9AD8\u4F4D\u4E3A0\n        return new long[]{0L, parseLong(traceIdHex)};\n    } else {\n        // \u5206\u5272\u4E3A\u9AD864\u4F4D\u548C\u4F4E64\u4F4D\n        String highHex = traceIdHex.substring(0, traceIdHex.length() - 16);\n        String lowHex = traceIdHex.substring(traceIdHex.length() - 16);\n        return new long[]{parseLong(highHex), parseLong(lowHex)};\n    }\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"4-\u914D\u7F6E\u4E0E\u96C6\u6210",children:"4. \u914D\u7F6E\u4E0E\u96C6\u6210"}),"\n",(0,c.jsx)(n.h3,{id:"41-tracer-\u521D\u59CB\u5316\u914D\u7F6E",children:"4.1 Tracer \u521D\u59CB\u5316\u914D\u7F6E"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'static Tracer tracer = new Configuration("order-service")\n    .withSampler(\n        new Configuration.SamplerConfiguration()\n            .withType("const")\n            .withParam(1)  // \u91C7\u6837\u7387 100%\n    )\n    .withReporter(\n        new Configuration.ReporterConfiguration()\n            .withLogSpans(true)  // \u5F00\u53D1\u73AF\u5883\u542F\u7528\u65E5\u5FD7\u8F93\u51FA\n            .withSender(\n                new Configuration.SenderConfiguration()\n                    .withAgentHost("localhost")\n                    .withAgentPort(6831)\n            )\n    )\n    .getTracerBuilder()\n    .withScopeManager(new CustomMDCScopeManager())  // \u5173\u952E\uFF1A\u6CE8\u5165\u81EA\u5B9A\u4E49\u7BA1\u7406\u5668\n    .build();\n'})}),"\n",(0,c.jsx)(n.h3,{id:"42-logback-\u914D\u7F6E",children:"4.2 Logback \u914D\u7F6E"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-xml",children:'<configuration>\n    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">\n        <encoder>\n            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} [traceId=%X{traceId} spanId=%X{spanId}] - %msg%n</pattern>\n        </encoder>\n    </appender>\n    \n    <appender name="JSON" class="ch.qos.logback.core.FileAppender">\n        <file>logs/app.json</file>\n        <encoder class="net.logstash.logback.encoder.LogstashEncoder">\n            <includeMdcKeyName>traceId</includeMdcKeyName>\n            <includeMdcKeyName>spanId</includeMdcKeyName>\n            <includeMdcKeyName>parentId</includeMdcKeyName>\n        </encoder>\n    </appender>\n    \n    <root level="INFO">\n        <appender-ref ref="CONSOLE" />\n        <appender-ref ref="JSON" />\n    </root>\n</configuration>\n'})}),"\n",(0,c.jsx)(n.h3,{id:"43-spring-boot-\u96C6\u6210\u53EF\u9009",children:"4.3 Spring Boot \u96C6\u6210\uFF08\u53EF\u9009\uFF09"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class TracingConfig {\n    \n    @Bean\n    public Tracer jaegerTracer() {\n        return new Configuration(\n                env.getProperty("spring.application.name", "unknown-service")\n            )\n            .withSampler(samplerConfig())\n            .withReporter(reporterConfig())\n            .getTracerBuilder()\n            .withScopeManager(new CustomMDCScopeManager())\n            .build();\n    }\n    \n    @Bean\n    public TracingFilter tracingFilter(Tracer tracer) {\n        return new TracingFilter(tracer);\n    }\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"5-\u4F7F\u7528\u573A\u666F\u4E0E\u6700\u4F73\u5B9E\u8DF5",children:"5. \u4F7F\u7528\u573A\u666F\u4E0E\u6700\u4F73\u5B9E\u8DF5"}),"\n",(0,c.jsx)(n.h3,{id:"51-\u63A5\u6536\u4E0A\u6E38-trace-\u4E0A\u4E0B\u6587",children:"5.1 \u63A5\u6536\u4E0A\u6E38 Trace \u4E0A\u4E0B\u6587"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'@RestController\npublic class OrderController {\n    \n    @GetMapping("/order/{id}")\n    public Order getOrder(\n        @PathVariable String id,\n        @RequestHeader(value = "uber-trace-id", required = false) String uberTraceId\n    ) {\n        JaegerSpanContext parentContext = parseUberTraceId(uberTraceId);\n        \n        Span span = tracer.buildSpan("get-order")\n            .asChildOf(parentContext)  // \u5173\u952E\uFF1A\u94FE\u63A5\u8FDC\u7A0B\u7236 Span\n            .withTag(Tags.SPAN_KIND, Tags.SPAN_KIND_SERVER)\n            .withTag("order.id", id)\n            .start();\n        \n        try (Scope scope = tracer.scopeManager().activate(span)) {\n            log.info("Processing order request");  // \u81EA\u52A8\u643A\u5E26 traceId/spanId\n            return orderService.getById(id);\n        } finally {\n            span.finish();\n        }\n    }\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"52-\u5411\u4E0B\u6E38\u4F20\u9012-trace-\u4E0A\u4E0B\u6587",children:"5.2 \u5411\u4E0B\u6E38\u4F20\u9012 Trace \u4E0A\u4E0B\u6587"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'public class PaymentClient {\n    \n    public void processPayment(String orderId) {\n        Span span = tracer.buildSpan("call-payment-service")\n            .withTag(Tags.SPAN_KIND, Tags.SPAN_KIND_CLIENT)\n            .start();\n        \n        try (Scope scope = tracer.scopeManager().activate(span)) {\n            HttpHeaders headers = new HttpHeaders();\n            \n            // \u6CE8\u5165 trace \u4E0A\u4E0B\u6587\u5230 HTTP Header\n            tracer.inject(\n                span.context(),\n                Format.Builtin.HTTP_HEADERS,\n                new HttpHeadersCarrier(headers)\n            );\n            \n            restTemplate.exchange(\n                "http://payment-service/pay",\n                HttpMethod.POST,\n                new HttpEntity<>(paymentRequest, headers),\n                PaymentResponse.class\n            );\n        } finally {\n            span.finish();\n        }\n    }\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"53-\u5F02\u6B65\u573A\u666F\u5904\u7406",children:"5.3 \u5F02\u6B65\u573A\u666F\u5904\u7406"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'@Service\npublic class AsyncOrderService {\n    \n    @Autowired\n    private Tracer tracer;\n    \n    @Autowired\n    private ExecutorService executorService;\n    \n    public void processOrderAsync(String orderId) {\n        Span parentSpan = tracer.activeSpan();  // \u83B7\u53D6\u5F53\u524D Span\n        \n        executorService.submit(() -> {\n            // \u5728\u65B0\u7EBF\u7A0B\u4E2D\u91CD\u65B0\u6FC0\u6D3B\u7236 Span\n            Span asyncSpan = tracer.buildSpan("async-process")\n                .asChildOf(parentSpan)\n                .start();\n            \n            try (Scope scope = tracer.scopeManager().activate(asyncSpan)) {\n                log.info("Async processing order");  // MDC \u6B63\u786E\u6CE8\u5165\n                // \u4E1A\u52A1\u903B\u8F91\n            } finally {\n                asyncSpan.finish();\n            }\n        });\n    }\n}\n'})}),"\n",(0,c.jsx)(n.h2,{id:"6-\u5173\u952E\u8BBE\u8BA1\u51B3\u7B56",children:"6. \u5173\u952E\u8BBE\u8BA1\u51B3\u7B56"}),"\n",(0,c.jsx)(n.h3,{id:"61-\u4E3A\u4EC0\u4E48\u4E0D\u76F4\u63A5\u5728\u4E1A\u52A1\u4EE3\u7801\u4E2D\u64CD\u4F5C-mdc",children:"6.1 \u4E3A\u4EC0\u4E48\u4E0D\u76F4\u63A5\u5728\u4E1A\u52A1\u4EE3\u7801\u4E2D\u64CD\u4F5C MDC\uFF1F"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u95EE\u9898"}),"\uFF1A\u624B\u52A8\u7BA1\u7406\u5BB9\u6613\u9057\u6F0F\u6E05\u7406\uFF0C\u5BFC\u81F4\u7EBF\u7A0B\u6C60\u590D\u7528\u65F6 traceId \u6C61\u67D3"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u89E3\u51B3\u65B9\u6848"}),"\uFF1A\u901A\u8FC7 ScopeManager \u7684\u751F\u547D\u5468\u671F\u7BA1\u7406\uFF0C\u5728 ",(0,c.jsx)(n.code,{children:"activate()"})," \u65F6\u6CE8\u5165\uFF0C\u5728 ",(0,c.jsx)(n.code,{children:"close()"})," \u65F6\u81EA\u52A8\u6E05\u7406"]}),"\n",(0,c.jsx)(n.h3,{id:"62-\u4E3A\u4EC0\u4E48\u9700\u8981\u4FDD\u5B58-mdc-\u5FEB\u7167",children:"6.2 \u4E3A\u4EC0\u4E48\u9700\u8981\u4FDD\u5B58 MDC \u5FEB\u7167\uFF1F"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u573A\u666F"}),"\uFF1A\u5D4C\u5957 Span \u8C03\u7528\u65F6\uFF0C\u9700\u8981\u5728\u5B50 Span \u7ED3\u675F\u540E\u6062\u590D\u7236 Span \u7684 MDC"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u5B9E\u73B0"}),"\uFF1A"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'// \u8FDB\u5165\u5B50 Span \u65F6\nthis.previousTraceId = MDC.get("traceId");  // \u4FDD\u5B58\u5FEB\u7167\nMDC.put("traceId", childSpan.context().toTraceId());  // \u8986\u76D6\n\n// \u9000\u51FA\u5B50 Span \u65F6\nrestoreMDC("traceId", previousTraceId);  // \u6062\u590D\u5FEB\u7167\n'})}),"\n",(0,c.jsx)(n.h3,{id:"63-\u4E3A\u4EC0\u4E48\u4F7F\u7528-threadlocal-\u800C\u4E0D\u662F-inheritablethreadlocal",children:"6.3 \u4E3A\u4EC0\u4E48\u4F7F\u7528 ThreadLocal \u800C\u4E0D\u662F InheritableThreadLocal\uFF1F"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u8003\u91CF"}),"\uFF1A"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"ThreadLocal"}),"\uFF1A\u4E25\u683C\u7EBF\u7A0B\u9694\u79BB\uFF0C\u9002\u5408\u540C\u6B65\u573A\u666F"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"InheritableThreadLocal"}),"\uFF1A\u5B50\u7EBF\u7A0B\u7EE7\u627F\u7236\u7EBF\u7A0B\u503C\uFF0C\u4F46\u5728\u7EBF\u7A0B\u6C60\u590D\u7528\u65F6\u5BB9\u6613\u51FA\u73B0\u4E0A\u4E0B\u6587\u6CC4\u6F0F"]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u63A8\u8350"}),"\uFF1A\u5F02\u6B65\u573A\u666F\u663E\u5F0F\u4F20\u9012 Span\uFF0C\u800C\u975E\u4F9D\u8D56\u81EA\u52A8\u7EE7\u627F"]}),"\n",(0,c.jsx)(n.h2,{id:"7-\u76D1\u63A7\u4E0E\u8C03\u8BD5",children:"7. \u76D1\u63A7\u4E0E\u8C03\u8BD5"}),"\n",(0,c.jsx)(n.h3,{id:"71-\u65E5\u5FD7\u8F93\u51FA\u793A\u4F8B",children:"7.1 \u65E5\u5FD7\u8F93\u51FA\u793A\u4F8B"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"21:45:32.123 [http-nio-8080-exec-1] INFO  c.w.OrderService [traceId=04bf92f3577b34da63ce929d0e0e4736 spanId=36bd32b7a5712a1a] - Processing order ORD-001\n21:45:32.234 [http-nio-8080-exec-1] INFO  c.w.PaymentClient [traceId=04bf92f3577b34da63ce929d0e0e4736 spanId=7f3a28b9c4d5e6a1] - Calling payment service\n21:45:32.456 [http-nio-8080-exec-1] INFO  c.w.OrderService [traceId=04bf92f3577b34da63ce929d0e0e4736 spanId=36bd32b7a5712a1a] - Order processed successfully\n"})}),"\n",(0,c.jsx)(n.h3,{id:"72-jaeger-ui-\u67E5\u8BE2",children:"7.2 Jaeger UI \u67E5\u8BE2"}),"\n",(0,c.jsx)(n.p,{children:"\u5728 Jaeger UI \u4E2D\u53EF\u4EE5\uFF1A"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["\u901A\u8FC7 traceId ",(0,c.jsx)(n.code,{children:"04bf92f3577b34da63ce929d0e0e4736"})," \u67E5\u770B\u5B8C\u6574\u8C03\u7528\u94FE"]}),"\n",(0,c.jsxs)(n.li,{children:["\u67E5\u770B\u6BCF\u4E2A Span \u7684 Tags\uFF08\u5982 ",(0,c.jsx)(n.code,{children:"db.statement"}),", ",(0,c.jsx)(n.code,{children:"http.status_code"}),"\uFF09"]}),"\n",(0,c.jsx)(n.li,{children:"\u67E5\u770B Span \u4E4B\u95F4\u7684\u7236\u5B50\u5173\u7CFB\u548C\u8017\u65F6\u5206\u5E03"}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"73-\u5E38\u89C1\u95EE\u9898\u6392\u67E5",children:"7.3 \u5E38\u89C1\u95EE\u9898\u6392\u67E5"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"\u95EE\u9898\u73B0\u8C61"}),(0,c.jsx)(n.th,{children:"\u53EF\u80FD\u539F\u56E0"}),(0,c.jsx)(n.th,{children:"\u6392\u67E5\u65B9\u6CD5"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"\u65E5\u5FD7\u4E2D traceId \u4E3A\u7A7A"}),(0,c.jsx)(n.td,{children:"\u672A\u6FC0\u6D3B Span \u6216 ScopeManager \u672A\u6B63\u786E\u914D\u7F6E"}),(0,c.jsxs)(n.td,{children:["\u68C0\u67E5 ",(0,c.jsx)(n.code,{children:"activate()"})," \u8C03\u7528\u548C Tracer \u6784\u5EFA"]})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"traceId \u5728\u4E0D\u540C\u8BF7\u6C42\u95F4\u4E32\u53F0"}),(0,c.jsx)(n.td,{children:"MDC \u672A\u6B63\u786E\u6E05\u7406\uFF08\u7EBF\u7A0B\u6C60\u590D\u7528\uFF09"}),(0,c.jsxs)(n.td,{children:["\u786E\u4FDD ",(0,c.jsx)(n.code,{children:"finally"})," \u5757\u4E2D\u8C03\u7528 ",(0,c.jsx)(n.code,{children:"MDC.remove()"})]})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"\u5B50 Span \u672A\u94FE\u63A5\u5230\u7236 Span"}),(0,c.jsxs)(n.td,{children:[(0,c.jsx)(n.code,{children:"asChildOf()"})," \u53C2\u6570\u9519\u8BEF"]}),(0,c.jsx)(n.td,{children:"\u9A8C\u8BC1 parentSpanId \u662F\u5426\u6B63\u786E\u89E3\u6790"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Jaeger \u4E2D\u770B\u4E0D\u5230 Span"}),(0,c.jsx)(n.td,{children:"\u91C7\u6837\u7387\u8BBE\u7F6E\u4E3A0\u6216 Reporter \u914D\u7F6E\u9519\u8BEF"}),(0,c.jsxs)(n.td,{children:["\u68C0\u67E5 ",(0,c.jsx)(n.code,{children:"withParam(1)"})," \u548C\u7F51\u7EDC\u8FDE\u901A\u6027"]})]})]})]}),"\n",(0,c.jsx)(n.h2,{id:"8-\u6027\u80FD\u8003\u91CF",children:"8. \u6027\u80FD\u8003\u91CF"}),"\n",(0,c.jsx)(n.h3,{id:"81-\u6027\u80FD\u5F71\u54CD\u5206\u6790",children:"8.1 \u6027\u80FD\u5F71\u54CD\u5206\u6790"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"\u64CD\u4F5C"}),(0,c.jsx)(n.th,{children:"\u8017\u65F6"}),(0,c.jsx)(n.th,{children:"\u5F71\u54CD"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"MDC.put()"}),(0,c.jsx)(n.td,{children:"< 1\u03BCs"}),(0,c.jsx)(n.td,{children:"\u53EF\u5FFD\u7565"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"ThreadLocal.get()"}),(0,c.jsx)(n.td,{children:"< 1\u03BCs"}),(0,c.jsx)(n.td,{children:"\u53EF\u5FFD\u7565"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Span.start()"}),(0,c.jsx)(n.td,{children:"~10\u03BCs"}),(0,c.jsx)(n.td,{children:"\u4F4E"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Span.finish() + \u4E0A\u62A5"}),(0,c.jsx)(n.td,{children:"~100\u03BCs"}),(0,c.jsx)(n.td,{children:"\u5F02\u6B65\u4E0A\u62A5\uFF0C\u5BF9\u4E3B\u6D41\u7A0B\u5F71\u54CD\u5C0F"})]})]})]}),"\n",(0,c.jsx)(n.h3,{id:"82-\u4F18\u5316\u5EFA\u8BAE",children:"8.2 \u4F18\u5316\u5EFA\u8BAE"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u5408\u7406\u63A7\u5236\u91C7\u6837\u7387"}),"\uFF1A\u751F\u4EA7\u73AF\u5883\u53EF\u8BBE\u7F6E\u4E3A 0.1\uFF0810%\uFF09\u4EE5\u964D\u4F4E\u5B58\u50A8\u6210\u672C"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u6279\u91CF\u4E0A\u62A5"}),"\uFF1AReporter \u914D\u7F6E ",(0,c.jsx)(n.code,{children:"withFlushInterval(1000)"})," \u6279\u91CF\u53D1\u9001 Span"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u907F\u514D\u8FC7\u5EA6 Span"}),"\uFF1A\u4E0D\u8981\u4E3A\u6BCF\u4E2A\u6570\u636E\u5E93\u67E5\u8BE2\u90FD\u521B\u5EFA Span\uFF0C\u63A7\u5236\u7C92\u5EA6"]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"9-\u6269\u5C55\u65B9\u5411",children:"9. \u6269\u5C55\u65B9\u5411"}),"\n",(0,c.jsx)(n.h3,{id:"91-\u652F\u6301\u54CD\u5E94\u5F0F\u7F16\u7A0Breactorwebflux",children:"9.1 \u652F\u6301\u54CD\u5E94\u5F0F\u7F16\u7A0B\uFF08Reactor/WebFlux\uFF09"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:'public class ReactorScopeManager implements ScopeManager {\n    @Override\n    public Scope activate(Span span) {\n        return new ReactorScope(span);\n    }\n    \n    static class ReactorScope implements Scope {\n        ReactorScope(Span span) {\n            // \u4F7F\u7528 Reactor Context \u800C\u975E ThreadLocal\n            Context.of("span", span);\n        }\n    }\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"92-\u96C6\u6210-spring-cloud-sleuth",children:"9.2 \u96C6\u6210 Spring Cloud Sleuth"}),"\n",(0,c.jsx)(n.p,{children:"Spring Cloud Sleuth \u63D0\u4F9B\u4E86\u5F00\u7BB1\u5373\u7528\u7684\u5206\u5E03\u5F0F\u8FFD\u8E2A\uFF0C\u53EF\u66FF\u4EE3\u672C\u65B9\u6848\uFF1A"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-sleuth</artifactId>\n</dependency>\n"})}),"\n",(0,c.jsx)(n.h3,{id:"93-\u652F\u6301-opentelemetry",children:"9.3 \u652F\u6301 OpenTelemetry"}),"\n",(0,c.jsx)(n.p,{children:"OpenTelemetry \u662F\u65B0\u4E00\u4EE3\u53EF\u89C2\u6D4B\u6027\u6807\u51C6\uFF0C\u5EFA\u8BAE\u672A\u6765\u8FC1\u79FB\uFF1A"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-java",children:"OpenTelemetry openTelemetry = AutoConfiguredOpenTelemetrySdk\n    .initialize()\n    .getOpenTelemetrySdk();\n"})}),"\n",(0,c.jsx)(n.h2,{id:"10-\u603B\u7ED3",children:"10. \u603B\u7ED3"}),"\n",(0,c.jsxs)(n.p,{children:["\u672C\u65B9\u6848\u901A\u8FC7\u81EA\u5B9A\u4E49 ",(0,c.jsx)(n.code,{children:"ScopeManager"})," \u5B9E\u73B0\u4E86 Jaeger Trace \u4E0E SLF4J MDC \u7684\u65E0\u7F1D\u96C6\u6210\uFF0C\u5177\u5907\u4EE5\u4E0B\u7279\u70B9\uFF1A"]}),"\n",(0,c.jsxs)(n.p,{children:["\u2705 ",(0,c.jsx)(n.strong,{children:"\u81EA\u52A8\u5316"}),"\uFF1AScope \u751F\u547D\u5468\u671F\u7BA1\u7406\uFF0C\u65E0\u9700\u624B\u52A8\u64CD\u4F5C MDC",(0,c.jsx)(n.br,{}),"\n","\u2705 ",(0,c.jsx)(n.strong,{children:"\u7EBF\u7A0B\u5B89\u5168"}),"\uFF1AThreadLocal \u9694\u79BB + \u5FEB\u7167\u6062\u590D\u673A\u5236",(0,c.jsx)(n.br,{}),"\n","\u2705 ",(0,c.jsx)(n.strong,{children:"\u5D4C\u5957\u652F\u6301"}),"\uFF1A\u94FE\u8868\u7ED3\u6784\u7EF4\u62A4\u591A\u5C42 Span \u5173\u7CFB",(0,c.jsx)(n.br,{}),"\n","\u2705 ",(0,c.jsx)(n.strong,{children:"\u751F\u4EA7\u53EF\u7528"}),"\uFF1A\u5DF2\u8003\u8651\u7EBF\u7A0B\u6C60\u590D\u7528\u3001\u5F02\u6B65\u573A\u666F\u7B49\u8FB9\u754C\u60C5\u51B5"]}),"\n",(0,c.jsx)(n.p,{children:"\u8BE5\u65B9\u6848\u9002\u7528\u4E8E\u9700\u8981\u7CBE\u7EC6\u63A7\u5236 trace \u4E0A\u4E0B\u6587\u4F20\u64AD\u7684\u5FAE\u670D\u52A1\u67B6\u6784\uFF0C\u7279\u522B\u662F\u9700\u8981\u63A5\u6536\u4E0A\u6E38 trace \u4FE1\u606F\u7684\u670D\u52A1\u7F51\u5173\u3001BFF \u5C42\u7B49\u573A\u666F\u3002"})]})}function p(e={}){let{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(o,{...e})}):o(e)}}}]);
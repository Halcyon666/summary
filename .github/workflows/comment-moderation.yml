name: Comment Moderation

on:
  discussion_comment:
    types: [created, edited]
  discussion:
    types: [created, edited]

permissions:
  discussions: write
  contents: read

jobs:
  moderate:
    runs-on: ubuntu-latest
    # é˜²æ­¢ Bot è§¦å‘å·¥ä½œæµå¯¼è‡´æ­»å¾ªç¯
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Check for inappropriate content
        uses: actions/github-script@v7
        env:
          BANNED_WORDS_JSON: ${{ secrets.BANNED_WORDS }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // === æ•æ„Ÿè¯é…ç½®åŒºåŸŸ ===
            // ä» GitHub Secrets è·å–æ•æ„Ÿè¯åˆ—è¡¨ (JSON æ ¼å¼)
            let bannedWords = [];
            try {
              const envWords = process.env.BANNED_WORDS_JSON;
              if (envWords) {
                bannedWords = JSON.parse(envWords);
              } else {
                console.log('âš ï¸ Warning: BANNED_WORDS secret is not set or empty.');
              }
            } catch (e) {
              console.error('âŒ Error parsing BANNED_WORDS secret:', e);
            }
            
            // å¦‚æœ Secrets ä¸ºç©ºï¼Œä½¿ç”¨æœ€å°é»˜è®¤åˆ—è¡¨ï¼ˆé˜²æ­¢æœªé…ç½®æ—¶çš„å®Œå…¨å¤±æ•ˆï¼‰
            if (bannedWords.length === 0) {
              bannedWords = ['spam', 'å¹¿å‘Š']; 
              console.log('â„¹ï¸ Using default minimal banned words list.');
            }
            
            // === é€»è¾‘å¤„ç†åŒºåŸŸ ===
            try {
              let commentBody = '';
              let commentId = null;
              let discussionNumber = null;
              let author = context.actor;

              // å®‰å…¨è·å– payload æ•°æ®
              if (context.eventName === 'discussion_comment' && context.payload.comment) {
                commentBody = context.payload.comment.body || '';
                commentId = context.payload.comment.node_id;
                discussionNumber = context.payload.discussion ? context.payload.discussion.number : null;
              } else if (context.eventName === 'discussion' && context.payload.discussion) {
                commentBody = context.payload.discussion.body || '';
                discussionNumber = context.payload.discussion.number;
              }

              if (!commentBody || !discussionNumber) {
                console.log('Skipping: No comment body or discussion number found.');
                return;
              }
              
              // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿè¯
              const lowerBody = commentBody.toLowerCase();
              const foundWords = bannedWords.filter(word => 
                lowerBody.includes(word.toLowerCase())
              );
              
              if (foundWords.length > 0) {
                console.log(`âš ï¸ Found inappropriate content by ${author}: ${foundWords.join(', ')}`);
                
                // 1. åˆ é™¤è¿è§„è¯„è®º / Delete the comment via GraphQL
                if (context.eventName === 'discussion_comment') {
                  try {
                    // ä½¿ç”¨ GraphQL åˆ é™¤è¯„è®º
                    const mutation = `
                      mutation deleteComment($id: ID!) {
                        deleteDiscussionComment(input: {id: $id}) {
                          clientMutationId
                        }
                      }
                    `;
                    
                    await github.graphql(mutation, {
                      id: commentId
                    });
                    
                    console.log(`ğŸ—‘ï¸ Deleted comment ${commentId}`);
                  } catch (err) {
                    console.error('Failed to delete comment:', err);
                    core.setFailed(`Failed to delete comment: ${err.message}`);
                  }
                } else if (context.eventName === 'discussion') {
                  // å¦‚æœæ˜¯æ•´ä¸ªè®¨è®ºå¸–è¿è§„ï¼Œåˆ™åˆ é™¤è®¨è®º via GraphQL
                  try {
                    // è¿™é‡Œçš„ commentId å¯¹äº discussion äº‹ä»¶æ¥è¯´æ˜¯ discussion.node_id
                    const discussionNodeId = context.payload.discussion.node_id;
                    
                    const mutation = `
                      mutation deleteDiscussion($id: ID!) {
                        deleteDiscussion(input: {id: $id}) {
                          clientMutationId
                        }
                      }
                    `;

                    await github.graphql(mutation, {
                      id: discussionNodeId
                    });

                    console.log(`ğŸ—‘ï¸ Deleted discussion ${discussionNodeId}`);
                  } catch (err) {
                    console.error('Failed to delete discussion:', err);
                    core.setFailed(`Failed to delete discussion: ${err.message}`);
                  }
                }

                // 2. è®°å½•æ—¥å¿—
                core.warning(`ğŸ—‘ï¸ Automatically deleted inappropriate content in discussion #${discussionNumber} by ${author}. Keywords: ${foundWords.join(', ')}`);
                
              } else {
                console.log('âœ… Content passed moderation check');
              }
            } catch (error) {
              console.error('Error in moderation script:', error);
              core.setFailed(`Moderation script failed: ${error.message}`);
            }

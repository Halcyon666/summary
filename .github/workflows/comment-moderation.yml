name: Comment Moderation

on:
  discussion_comment:
    types: [created]
  discussion:
    types: [created]

permissions:
  discussions: write
  contents: read

jobs:
  moderate:
    runs-on: ubuntu-latest
    # é˜²æ­¢ Bot è§¦å‘å·¥ä½œæµå¯¼è‡´æ­»å¾ªç¯
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Check for inappropriate content
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // === æ•æ„Ÿè¯é…ç½®åŒºåŸŸ ===
            const bannedWords = [
              // 1. åƒåœ¾å¹¿å‘Š / Spam
              'spam', 'å¹¿å‘Š', 'æ¨å¹¿', 'è¥é”€', 'ä»£å¼€', 'å‘ç¥¨', 
              'åŠ å¾®ä¿¡', 'åŠ qq', 'åŠ ç¾¤', 'è”ç³»æˆ‘', 'ç§èŠ',
              'å…¼èŒ', 'åˆ·å•', 'åˆ·é’»', 'é¢†çš®è‚¤', 'å…è´¹é€',
              'discount', 'sale', 'promo', 'buy now', 'click here',
              
              // 2. è¿ç¦å†…å®¹ / Illegal
              'VPN', 'ç¿»å¢™', 'æ¢¯å­', 'ç§‘å­¦ä¸Šç½‘',
              'è‰²æƒ…', 'èµŒåš', 'æ¯’å“', 'porn', 'gamble', 'drug',
              'æªæ”¯', 'è¿·è¯', 'ç›‘å¬',
              
              // 3. ä¾®è¾±è°©éª‚ / Insult (æ…ç”¨ï¼Œé˜²æ­¢è¯¯ä¼¤)
              'å‚»é€¼', 'è„‘æ®‹', 'å¼±æ™º', 'åºŸç‰©', 'æ­»å¦ˆ', 'åƒåœ¾', 
              'fuck', 'shit', 'bitch', 'asshole', 'idiot', 'stupid',
              'nigger', 'chink'
            ];
            
            // === é€»è¾‘å¤„ç†åŒºåŸŸ ===
            try {
              let commentBody = '';
              let commentId = null;
              let discussionNumber = null;
              let author = context.actor;

              // å®‰å…¨è·å– payload æ•°æ®
              if (context.eventName === 'discussion_comment' && context.payload.comment) {
                commentBody = context.payload.comment.body || '';
                commentId = context.payload.comment.node_id;
                discussionNumber = context.payload.discussion ? context.payload.discussion.number : null;
              } else if (context.eventName === 'discussion' && context.payload.discussion) {
                commentBody = context.payload.discussion.body || '';
                discussionNumber = context.payload.discussion.number;
              }

              if (!commentBody || !discussionNumber) {
                console.log('Skipping: No comment body or discussion number found.');
                return;
              }
              
              // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿè¯
              const lowerBody = commentBody.toLowerCase();
              const foundWords = bannedWords.filter(word => 
                lowerBody.includes(word.toLowerCase())
              );
              
              if (foundWords.length > 0) {
                console.log(`âš ï¸ Found inappropriate content by ${author}: ${foundWords.join(', ')}`);
                
                // 1. åˆ é™¤è¿è§„è¯„è®º / Delete the comment via GraphQL
                if (context.eventName === 'discussion_comment') {
                  try {
                    // ä½¿ç”¨ GraphQL åˆ é™¤è¯„è®º
                    const mutation = `
                      mutation deleteComment($id: ID!) {
                        deleteDiscussionComment(input: {id: $id}) {
                          clientMutationId
                        }
                      }
                    `;
                    
                    await github.graphql(mutation, {
                      id: commentId
                    });
                    
                    console.log(`ğŸ—‘ï¸ Deleted comment ${commentId}`);
                  } catch (err) {
                    console.error('Failed to delete comment:', err);
                    core.setFailed(`Failed to delete comment: ${err.message}`);
                  }
                } else if (context.eventName === 'discussion') {
                  // å¦‚æœæ˜¯æ•´ä¸ªè®¨è®ºå¸–è¿è§„ï¼Œåˆ™åˆ é™¤è®¨è®º via GraphQL
                  try {
                    // è¿™é‡Œçš„ commentId å¯¹äº discussion äº‹ä»¶æ¥è¯´æ˜¯ discussion.node_id
                    const discussionNodeId = context.payload.discussion.node_id;
                    
                    const mutation = `
                      mutation deleteDiscussion($id: ID!) {
                        deleteDiscussion(input: {id: $id}) {
                          clientMutationId
                        }
                      }
                    `;

                    await github.graphql(mutation, {
                      id: discussionNodeId
                    });

                    console.log(`ğŸ—‘ï¸ Deleted discussion ${discussionNodeId}`);
                  } catch (err) {
                    console.error('Failed to delete discussion:', err);
                    core.setFailed(`Failed to delete discussion: ${err.message}`);
                  }
                }

                // 2. è®°å½•æ—¥å¿—
                core.warning(`ğŸ—‘ï¸ Automatically deleted inappropriate content in discussion #${discussionNumber} by ${author}. Keywords: ${foundWords.join(', ')}`);
                
              } else {
                console.log('âœ… Content passed moderation check');
              }
            } catch (error) {
              console.error('Error in moderation script:', error);
              core.setFailed(`Moderation script failed: ${error.message}`);
            }

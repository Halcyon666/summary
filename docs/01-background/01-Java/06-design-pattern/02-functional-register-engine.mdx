# åŠŸèƒ½æ³¨å†Œå¼•æ“è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

æœ¬è®¾è®¡å®ç°äº†ä¸€ä¸ªåŸºäºæ³¨è§£é©±åŠ¨çš„ä¸šåŠ¡-æ¨¡æ¿æ³¨å†Œå¼•æ“ï¼Œé€šè¿‡ `@UseTemplate` æ³¨è§£åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç»‘å®šä¸šåŠ¡å®ç°ç±»ä¸å¯¹åº”çš„å¤„ç†æ¨¡æ¿ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸å¤„ç†æµç¨‹çš„è§£è€¦ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

- âœ… æ³¨è§£é©±åŠ¨çš„è‡ªåŠ¨æ³¨å†Œæœºåˆ¶
- âœ… æ³›å‹ç±»å‹å®‰å…¨æ£€æŸ¥
- âœ… å‡½æ•°å¼ç¼–ç¨‹é£æ ¼
- âœ… Spring Boot é›†æˆ
- âœ… çµæ´»çš„æ¨¡æ¿åŒ–å¤„ç†æµç¨‹

------

## 2. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 2.1 RegisterEnginV3 - æ³¨å†Œå¼•æ“

**èŒè´£**ï¼š

- å¯åŠ¨æ—¶æ‰«ææ‰€æœ‰ Business å®ç°ç±»
- è§£æ `@UseTemplate` æ³¨è§£ï¼Œç»‘å®šä¸šåŠ¡ä¸æ¨¡æ¿
- æ‰§è¡Œæ³›å‹ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥
- æä¾›ç»Ÿä¸€çš„ä¸šåŠ¡æ‰§è¡Œå…¥å£

**å…³é”®ä»£ç **ï¼š

```java
@Service
@AllArgsConstructor
public class RegisterEnginV3<T, S extends Business<T>> {

    @PostConstruct
    public void init() {
        businessesMap.forEach((txcode, businessService) -> {
            // 1. è§£æ @UseTemplate æ³¨è§£
            UseTemplate ann = businessService.getClass()
                .getAnnotation(UseTemplate.class);

            // 2. è·å–å¯¹åº”çš„ Template Bean
            Template<T, S> templateToUse =
                (Template<T, S>) applicationContext
                    .getBean(ann.value());

            // 3. æ³›å‹ç±»å‹æ£€æŸ¥
            checkConsistentGenericType(businessService, templateToUse);

            // 4. æ³¨å†Œåˆ°æ‰§è¡Œæ³¨å†Œè¡¨
            registry.put(txcode,
                param -> templateToUse.handler(txcode, param, businessService));
        });
    }

    public void run(String businessType, T params) {
        registry.get(businessType).accept(params);
    }
}
```

**æ³›å‹å‚æ•°è¯´æ˜**ï¼š

- `T`: ä¸šåŠ¡å¤„ç†çš„å‚æ•°ç±»å‹ï¼ˆé€šå¸¸æ˜¯ `BusinessContext<I, O>`ï¼‰
- `S`: å…·ä½“çš„ Business å®ç°ç±»å‹

------

### 2.2 Template - å¤„ç†æ¨¡æ¿æ¥å£

**è®¾è®¡ç†å¿µ**ï¼š é‡‡ç”¨å‡½æ•°å¼æ¥å£è®¾è®¡ï¼Œå®šä¹‰ç»Ÿä¸€çš„ä¸šåŠ¡å¤„ç†æµç¨‹ã€‚

```java
@FunctionalInterface
public interface Template<T, S extends Business<T>> {
    void handler(String txcode, T param, S businessService);
}
```

**å®ç°ç¤ºä¾‹**ï¼š

```java
@Component
public class TemplateImpl3<I, O> implements
    Template<BusinessContext<I, O>, BusinessType3<I, O>> {

    @Override
    public void handler(String txcode,
                       BusinessContext<I, O> param,
                       BusinessType3<I, O> businessService) {
        // å‰ç½®å¤„ç†
        // ...

        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        businessService.doBusiness2(param);

        // åç½®å¤„ç†
        // ...
    }
}
```

------

### 2.3 Business - ä¸šåŠ¡æ¥å£å±‚æ¬¡

**æ¥å£å±‚æ¬¡è®¾è®¡**ï¼š

```
Business<T> (æ ‡è®°æ¥å£)
    â†“
BusinessType3<I, O> extends Business<BusinessContext<I, O>>
    â†“
Business3 implements BusinessType3<InputDto3, OutputDto3>
```

**Business åŸºç¡€æ¥å£**ï¼š

```java
public interface Business<T> {
    // æ ‡è®°æ¥å£ï¼Œç”¨äºç±»å‹çº¦æŸ
}
```

**ä¸šåŠ¡ç±»å‹æ¥å£**ï¼š

```java
public interface BusinessType3<I, O>
    extends Business<BusinessContext<I, O>> {

    void doBusiness2(BusinessContext<I, O> businessContext);
}
```

**å…·ä½“ä¸šåŠ¡å®ç°**ï¼š

```java
@Service
@UseTemplate(TemplateImpl3.class)  // ğŸ‘ˆ å…³é”®æ³¨è§£
public class Business3 implements
    BusinessType3<InputDto3, OutputDto3> {

    @Override
    public void doBusiness2(BusinessContext<InputDto3, OutputDto3> ctx) {
        OutputDto3 output = new OutputDto3();
        output.setField2("result from Business3");
        output.setField3("xxx");
        ctx.setOutput(output);
    }
}
```

------

### 2.4 @UseTemplate æ³¨è§£

**å®šä¹‰**ï¼š

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface UseTemplate {
    Class<?> value();  // æŒ‡å®šä½¿ç”¨çš„ Template å®ç°ç±»
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š åœ¨ Business å®ç°ç±»ä¸Šæ ‡æ³¨ï¼ŒæŒ‡å®šè¯¥ä¸šåŠ¡ä½¿ç”¨çš„å¤„ç†æ¨¡æ¿ã€‚

------

## 3. æ•°æ®æµè½¬è®¾è®¡

### 3.1 BusinessContext ä¸Šä¸‹æ–‡

```java
@Data
public class BusinessContext<I, O> {
    private I input;        // è¾“å…¥å‚æ•°
    private O output;       // è¾“å‡ºç»“æœ
    private OtherDto3 otherDto;  // å…¶ä»–ä¸Šä¸‹æ–‡ä¿¡æ¯
}
```

### 3.2 æ‰§è¡Œæµç¨‹

```
å®¢æˆ·ç«¯è°ƒç”¨
    â†“
RegisterEnginV3.run(businessType, params)
    â†“
ä»æ³¨å†Œè¡¨è·å– Consumer<T>
    â†“
Template.handler(txcode, param, businessService)
    â†“
BusinessService.doBusiness(param)
    â†“
è¿”å›ç»“æœï¼ˆé€šè¿‡ BusinessContextï¼‰
```

------

## 4. ç±»å‹å®‰å…¨æœºåˆ¶

### 4.1 æ³›å‹ç±»å‹æ£€æŸ¥

```java
private static <T, S extends Business<T>> void
    checkConsistentGenericType(S businessService,
                               Template<T, S> templateToUse) {

    Class<?> templateGeneric = getGeneric(templateToUse, Template.class);
    Class<?> businessGeneric = getGeneric(businessService, Business.class);

    if (businessGeneric != null && templateGeneric != null &&
        !templateGeneric.isAssignableFrom(businessGeneric)) {
        throw new IllegalStateException("âŒ Template type mismatch");
    }
}
```

### 4.2 ç±»å‹ä¸åŒ¹é…ç¤ºä¾‹

```java
// âŒ é”™è¯¯ç¤ºä¾‹
@UseTemplate(TemplateImpl1.class)  // æœŸæœ› BusinessContext<A, B>
public class Business3 implements
    BusinessType3<InputDto3, OutputDto3> {  // å®é™… BusinessContext<InputDto3, OutputDto3>
    // å¯åŠ¨æ—¶ä¼šæŠ›å‡º IllegalStateException
}
```

------

## 5. Bean å‘½åç­–ç•¥

### 5.1 UniquePackageBeanNameGenerator

**é—®é¢˜èƒŒæ™¯**ï¼š å½“å¤šä¸ªåŒ…ä¸‹å­˜åœ¨åŒå Business ç±»æ—¶ï¼ŒSpring é»˜è®¤å‘½åç­–ç•¥ä¼šå¯¼è‡´ Bean åç§°å†²çªã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
public class UniquePackageBeanNameGenerator
    extends AnnotationBeanNameGenerator {

    @Override
    public String generateBeanName(BeanDefinition definition,
                                   BeanDefinitionRegistry registry) {
        String beanClassName = definition.getBeanClassName();
        String originalBeanName = super.generateBeanName(definition, registry);

        if (beanClassName != null) {
            try {
                Class<?> clazz = Class.forName(beanClassName);
                if (Business.class.isAssignableFrom(clazz)) {
                    return "NEW" + originalBeanName;  // æ·»åŠ å‰ç¼€
                }
            } catch (ClassNotFoundException e) {
                return originalBeanName;
            }
        }
        return originalBeanName;
    }
}
```

### 5.2 é…ç½®æ–¹å¼

```java
@SpringBootApplication
@ComponentScan(nameGenerator = UniquePackageBeanNameGenerator.class)
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

------

## 6. ä½¿ç”¨ç¤ºä¾‹

### 6.1 å®šä¹‰ DTO

```java
@Data
public class InputDto3 {
    private String field1;
}

@Data
public class OutputDto3 {
    private String field2;
    private String field3;
}
```

### 6.2 å®ç°ä¸šåŠ¡é€»è¾‘

```java
@Service
@UseTemplate(TemplateImpl3.class)
public class Business3 implements
    BusinessType3<InputDto3, OutputDto3> {

    @Override
    public void doBusiness2(BusinessContext<InputDto3, OutputDto3> ctx) {
        InputDto3 input = ctx.getInput();

        OutputDto3 output = new OutputDto3();
        output.setField2("å¤„ç†ç»“æœ: " + input.getField1());
        output.setField3("é¢å¤–ä¿¡æ¯");

        ctx.setOutput(output);
    }
}
```

### 6.3 è°ƒç”¨ä¸šåŠ¡

```java
@RestController
@AllArgsConstructor
public class BusinessController {

    private final RegisterEnginV3<BusinessContext<?, ?>, ?> registerEngine;

    @PostMapping("/execute/{businessType}")
    public BusinessContext<?, ?> execute(
            @PathVariable String businessType,
            @RequestBody InputDto3 input) {

        BusinessContext<InputDto3, OutputDto3> context =
            new BusinessContext<>();
        context.setInput(input);

        registerEngine.run(businessType, context);

        return context;
    }
}
```

------

## 7. ä¼˜åŠ¿ä¸æ‰©å±•æ€§

### 7.1 è®¾è®¡ä¼˜åŠ¿

| ç‰¹æ€§         | è¯´æ˜                           |
| ------------ | ------------------------------ |
| **ä½è€¦åˆ**   | ä¸šåŠ¡é€»è¾‘ä¸å¤„ç†æµç¨‹å®Œå…¨åˆ†ç¦»     |
| **é«˜å†…èš**   | ç›¸åŒç±»å‹ä¸šåŠ¡å…±äº«åŒä¸€æ¨¡æ¿       |
| **ç±»å‹å®‰å…¨** | ç¼–è¯‘æœŸ + è¿è¡ŒæœŸåŒé‡ç±»å‹æ£€æŸ¥    |
| **æ˜“æ‰©å±•**   | æ–°å¢ä¸šåŠ¡åªéœ€å®ç°æ¥å£å¹¶æ·»åŠ æ³¨è§£ |
| **å¯ç»´æŠ¤**   | ç»Ÿä¸€çš„æ³¨å†Œå’Œæ‰§è¡Œæœºåˆ¶           |

## 8. å¼‚å¸¸å¤„ç†

1. å®šä¹‰ç³»ç»Ÿå†…éƒ¨å¼‚å¸¸å’Œè‡ªå®šä¹‰é€šä¿¡å¼‚å¸¸
2. `Controller` æˆ–è€… `Service` ç»Ÿä¸€å¤„ç†è‡ªå®šä¹‰å¼‚å¸¸å’ŒæœªçŸ¥å¼‚å¸¸
3. å¦‚æœæœ‰ä¸éœ€è¦å“åº”çš„åœºæ™¯ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªä¸å“åº”çš„å¼‚å¸¸
4. å¦‚æœæœ‰å¤šä¸ªè¿œç¨‹è°ƒç”¨ï¼ŒæŒ‰å¤šç§è¿œç¨‹è°ƒç”¨çš„è‡ªå®šä¹‰å¼‚å¸¸æ¥å¤„ç†

---

## 9. æ€»ç»“

æœ¬è®¾è®¡é€šè¿‡æ³¨è§£é©±åŠ¨çš„æ–¹å¼å®ç°äº†ä¸šåŠ¡é€»è¾‘çš„çµæ´»æ³¨å†Œå’Œæ‰§è¡Œï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

âœ… **å£°æ˜å¼é…ç½®**ï¼šé€šè¿‡ `@UseTemplate` æ³¨è§£ç»‘å®šå…³ç³»

âœ… **ç±»å‹å®‰å…¨**ï¼šæ³›å‹ + åå°„å®ç°ç¼–è¯‘æœŸå’Œè¿è¡ŒæœŸåŒé‡æ£€æŸ¥

âœ… **é«˜åº¦è§£è€¦**ï¼šä¸šåŠ¡é€»è¾‘ä¸æ‰§è¡Œæµç¨‹å®Œå…¨åˆ†ç¦»

âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ä¸šåŠ¡æ— éœ€ä¿®æ”¹æ³¨å†Œå¼•æ“ä»£ç 

é€‚ç”¨åœºæ™¯ï¼š

- å¤šä¸šåŠ¡ç±»å‹çš„ç»Ÿä¸€å¤„ç†æ¡†æ¶
- éœ€è¦åŠ¨æ€æ‰©å±•ä¸šåŠ¡çš„ç³»ç»Ÿ
- ä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–çš„åœºæ™¯

------

import TailProtocal from "@site/src/components/TailProtocal";

<TailProtocal />

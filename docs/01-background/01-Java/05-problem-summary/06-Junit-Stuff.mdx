# jUnit Stuff

## Mockito å•å…ƒæµ‹è¯• vs Spring Boot æµ‹è¯•

æœ¬æ–‡æ•´ç†äº†ä¸¤ç§å¸¸ç”¨çš„æµ‹è¯•æ–¹å¼ï¼š

1. **çº¯å•å…ƒæµ‹è¯•ï¼ˆMockito + JUnitï¼‰**
2. **Spring Boot æµ‹è¯•ï¼ˆ@SpringBootTest æ’é™¤è‡ªåŠ¨è£…é…ï¼‰**



### Mockito JUnit

ç‰¹ç‚¹ï¼š

- ä¸ä¾èµ– Spring å®¹å™¨
- ä½¿ç”¨ `@ExtendWith(MockitoExtension.class)`
- é€‚åˆ Service å±‚é€»è¾‘æµ‹è¯•

<details>
<summary>ç¤ºä¾‹ä»£ç </summary>

```java title="CodeEntityServiceImplTest"
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import static org.junit.jupiter.api.Assertions.*;

@ExtendWith(MockitoExtension.class)
class CodeEntityServiceImplTest {

    @InjectMocks
    private CodeEntityServiceImpl codeEntityService;

    @Mock
    private CodeEntityMapper codeEntityMapper;

    @Test
    void testGetByIdMine_success() {
        CodeEntityPO po = new CodeEntityPO();
        po.setUsername("Candy");
        po.setCode("abc");

        Mockito.when(codeEntityMapper.selectById("abc")).thenReturn(po);

        CodeEntityPO result = codeEntityService.getByIdMine("abc");

        assertEquals("Candy", result.getUsername());
        assertEquals("abc", result.getCode());
    }

    @Test
    void testGetByIdMine_nullShouldThrow() {
        Mockito.when(codeEntityMapper.selectById("abc")).thenReturn(null);

        Exception ex = assertThrows(IllegalArgumentException.class, () -> {
            codeEntityService.getByIdMine1("abc");
        });

        assertEquals("Object must not be null", ex.getMessage());
    }
}
```
</details>

âœ… ä¼˜ç‚¹ï¼š

- å¿«é€Ÿæ‰§è¡Œ
- ä¸ä¾èµ–æ•°æ®åº“æˆ– Spring å®¹å™¨
- é€»è¾‘æµ‹è¯•æ¸…æ™°


### Spring Boot test

ç‰¹ç‚¹ï¼š

- ä¾èµ– Spring Boot ä¸Šä¸‹æ–‡ï¼Œä½†æ’é™¤äº†æ•°æ®åº“ç­‰è‡ªåŠ¨è£…é…
- ä½¿ç”¨ `@MockBean` æ›¿æ¢ Mapper æˆ– Service
- é€‚åˆ Service/Controller é€»è¾‘æµ‹è¯•


<details>
<summary>ç¤ºä¾‹ä»£ç </summary>

```java title="CodeEntityServiceImplBootTest"
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.beans.factory.annotation.Autowired;

@SpringBootTest(
    classes = YourMainApplication.class,
    properties = {
        "spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration"
    }
)
class CodeEntityServiceImplBootTest {

    @Autowired
    private CodeEntityServiceImpl codeEntityService;

    @MockBean
    private CodeEntityMapper codeEntityMapper;

    @Test
    void testGetByIdMine_success() {
        CodeEntityPO po = new CodeEntityPO();
        po.setUsername("Candy");
        po.setCode("abc");

        Mockito.when(codeEntityMapper.selectById("abc")).thenReturn(po);

        CodeEntityPO result = codeEntityService.getByIdMine("abc");

        assertEquals("Candy", result.getUsername());
        assertEquals("abc", result.getCode());
    }
}
```
</details>


ä¹Ÿå¯ä»¥ä½¿ç”¨`yml`æ–‡ä»¶æ¥æ’é™¤è‡ªåŠ¨è£…é…ï¼š

```yml title="application-test.yml"
spring:
 autoconfigure:
   exclude:
     - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
```
```java title="CodeEntityServiceImplBootTest"
@SpringBootTest(classes = App.class)
@ActiveProfiles("test")
```

âœ… ä¼˜ç‚¹ï¼š

- Spring ä¸Šä¸‹æ–‡å¯ç”¨ï¼Œä¾èµ–æ³¨å…¥æ­£å¸¸
- å¯ä»¥æµ‹è¯•å¸¦æœ‰äº‹åŠ¡æˆ– AOP çš„ Service
- é¿å…æ•°æ®åº“è¿æ¥æŠ¥é”™

[å®Œæ•´ä»£ç è®°å½•](https://github.com/Halcyon666/mybatis-plus/commit/d092b62282b1666aaaad46c46077114752a37115)

### static method mock

<details>
<summary>é™æ€æ–¹æ³•Mock</summary>
```java title="StaticMockTest"
import com.whalefall541.staticmock.ExternalLib;
import com.whalefall541.staticmock.MyService;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;

import java.util.function.Supplier;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.mockStatic;

class StaticMockTest {
    @Test
    void testStaticMockWithSupplier() {
        // 1. Create the static mock within a try-with-resources block
        try (MockedStatic<ExternalLib> mockedLib = mockStatic(ExternalLib.class)) {
            // 2. Define behavior: When compute() is called with ANY Supplier, return "Mocked"
            mockedLib.when(() -> ExternalLib.compute(any(Supplier.class)))
                    .thenReturn("Mocked Result");
            // 3. Execute the service method
            MyService service = new MyService();
            String result = service.getProcessedData();
            // 4. Verify the result is what we mocked
            assertEquals("Mocked Result", result);
            // Optional: Verify the static method was called exactly once
            mockedLib.verify(() -> ExternalLib.compute(any(Supplier.class)));
        }
    }

    @Test
    void testGetProcessedData1_FailureInsideSupplier() {
        try (MockedStatic<ExternalLib> mockedLib = mockStatic(ExternalLib.class)) {
            mockedLib.when(() -> ExternalLib.compute(any()))
                    .thenCallRealMethod();
            MyService service = new MyService();
            Exception exception = assertThrows(IllegalArgumentException.class, service::getProcessedData1);
            assertEquals("This will fail", exception.getMessage());
        }
    }
}
```
</details>

## Assert log content

1. [System out é‡å®šå‘](https://github.com/Halcyon666/learn-cases/blob/2e543cf044a8e67a0ae1cbde5fe3ab8aa5b1637e/learncases/src/test/java/com/whalefall/override/TestClassTest.java#L48)

2. LogCaptor (Recommendation)

```java title="MyServiceTest "
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.boot.test.system.CapturedOutput;
import org.springframework.boot.test.system.OutputCaptureExtension;

import static org.assertj.core.api.Assertions.assertThat;
// highlight-next-line
@ExtendWith(OutputCaptureExtension.class)
// If CapturedOutput is used by several methods, just opening next line comment
// @SpringBootTest
class MyServiceTest {
    
    @Test
    void shouldLogMessage(CapturedOutput output) {
		// highlight-next-line
        MyService service = new MyService();
        service.doSomething();
        assertThat(output.getOut()).contains("Expected log message");
    }
}
```

## Mock annotation

1. using spring boot test

getting the real annotation from classes

2. using a tempt inner class

```java
@UseTemplate(DemoTemplate.class)
static class DemoBusiness implements Business<String> {
    @Override
    public void process(String input) {
        // no-op
    }
}

static class DemoTemplate implements Template<String, DemoBusiness> {
    @Override
    public void handler(String txcode, String param, DemoBusiness businessService) {
        // mock behavior
    }
}
@Test
void testInit_withUseTemplateAnnotation() {
    ApplicationContext ctx = mock(ApplicationContext.class);
    DemoTemplate demoTemplate = new DemoTemplate();
    when(ctx.getBean(DemoTemplate.class)).thenReturn(demoTemplate);

    Map<String, DemoBusiness> map = Map.of("job1", new DemoBusiness());

    RegisterEnginV3<String, DemoBusiness> engin =
        new RegisterEnginV3<>(map, Map.of(), new HashMap<>(), ctx);

    engin.init(); // âœ… Will read @UseTemplate(DemoTemplate.class)
}
```

3. new a annotion instance to use.

## åŒä¸€ä¸ªç±»ä¸­å•å…ƒæµ‹è¯•æ–¹æ³•ä¹‹é—´ç›¸å…³å½±å“

veryè°ƒç”¨æ¬¡æ•°æœ¬æ¥æ˜¯ä¸€æ¬¡ï¼Œå‰é¢çš„ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ä¼šå½±å“åé¢çš„æ–¹æ³•ï¼Œéœ€è¦åœ¨å•å…ƒæµ‹è¯•ç±»ä¸Šé¢åŠ è¿™ä¸ªã€‚

```java
@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_EACH_TEST_METHOD)
```

## Depends on `@PostConstruct`

You can create it, pass parameter by new construction, then call the init method .

```java
@Service
@AllArgsConstructor
public class RegisterEnginV3<T, S extends Business<T>> {

    @PostConstruct
    public void init() {
        businessesMap.forEach((txcode, businessService) -> {
            // 1. è§£æ @UseTemplate æ³¨è§£
            UseTemplate ann = businessService.getClass()
                .getAnnotation(UseTemplate.class);

            // 2. è·å–å¯¹åº”çš„ Template Bean
            Template<T, S> templateToUse =
                (Template<T, S>) applicationContext
                    .getBean(ann.value());

            // 3. æ³›å‹ç±»å‹æ£€æŸ¥
            checkConsistentGenericType(businessService, templateToUse);

            // 4. æ³¨å†Œåˆ°æ‰§è¡Œæ³¨å†Œè¡¨
            registry.put(txcode,
                param -> templateToUse.handler(txcode, param, businessService));
        });
    }

    public void run(String businessType, T params) {
        registry.get(businessType).accept(params);
    }
}
```

## @MockBean å¤±æ•ˆé—®é¢˜

debugå‘ç°ä¸€ä¸ª@Resourceå¯¹è±¡é‡Œé¢çš„å±æ€§å·²ç»åœ¨å•å…ƒæµ‹è¯•ä¸­å†™äº†@MockBean ä½†æ˜¯ä¾ç„¶æ³¨å…¥äº†çœŸå®çš„å¯¹è±¡

**âœ… æ–¹æ¡ˆ 1ï¼šæ”¹ç”¨**

**@Autowired**

æœ€ç›´æ¥ã€å®˜æ–¹æ¨èçš„æ–¹å¼ã€‚

@MockBean ä¸“é—¨ä¸º @Autowired æœºåˆ¶è®¾è®¡ã€‚

## Mockçš„æ–¹æ³•æ”¹å˜å‚æ•°çš„å±æ€§

éå¸¸å¥½çš„é—®é¢˜ ğŸ‘

ä½ è¿™ä¸ªåœºæ™¯éå¸¸å…¸å‹ï¼š

âœ… é—®é¢˜åœºæ™¯

ä¸€ä¸ªè¢« @MockBean çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ service æˆ– clientï¼‰ï¼Œ

å®ƒæœ‰ä¸€ä¸ª void æ–¹æ³•ï¼Œåœ¨æ–¹æ³•é‡Œä¼šä¿®æ”¹ä½ ä¼ å…¥çš„å¯¹è±¡ï¼ˆä¾‹å¦‚è®¾ç½®å­—æ®µï¼‰ã€‚

åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œä½ æƒ³æ¨¡æ‹Ÿè¿™ä¸ªè¡Œä¸ºï¼Œè®©è¯¥å¯¹è±¡çš„å±æ€§è¢«è®¾ç½®ã€‚

```java
@Service
public class OrderService {
    @Autowired
    private PaymentClient paymentClient;

    public void process(OrderContext ctx) {
        paymentClient.fillPaymentInfo(ctx);  // void æ–¹æ³•ï¼Œå†…éƒ¨ä¼šè®¾ç½® ctx çš„å­—æ®µ
    }
}

public class PaymentClient {
    public void fillPaymentInfo(OrderContext ctx) {
        ctx.setPayStatus("SUCCESS");
        ctx.setPayAmount(100);
    }
}
```

doAnswer() å¯ä»¥è®©ä½ å®šä¹‰åœ¨è°ƒç”¨ void æ–¹æ³•æ—¶çš„è‡ªå®šä¹‰è¡Œä¸ºã€‚

```java
@SpringBootTest
class OrderServiceTest {

    @Autowired
    private OrderService orderService;

    @MockBean
    private PaymentClient paymentClient;

    @Test
    void testProcess() {
        // 1ï¸âƒ£ æ¨¡æ‹Ÿ PaymentClient å¯¹ fillPaymentInfo çš„è¡Œä¸º
        doAnswer(invocation -> {
            OrderContext ctx = invocation.getArgument(0);
            ctx.setPayStatus("MOCK_SUCCESS");
            ctx.setPayAmount(999);
            return null; // å› ä¸ºç›®æ ‡æ–¹æ³•æ˜¯ void
        }).when(paymentClient).fillPaymentInfo(any(OrderContext.class));

        // 2ï¸âƒ£ è°ƒç”¨å®é™…ä¸šåŠ¡
        OrderContext context = new OrderContext();
        orderService.process(context);

        // 3ï¸âƒ£ æ–­è¨€æ¨¡æ‹Ÿæ•ˆæœ
        assertEquals("MOCK_SUCCESS", context.getPayStatus());
        assertEquals(999, context.getPayAmount());
    }
}
```

import TailProtocal from "@site/src/components/TailProtocal";

<TailProtocal />

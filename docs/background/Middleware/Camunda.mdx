---
title: "Camunda Workflow Engine"
sidebar_label: "ğŸ”„ Camunda"
sidebar_position: 4
description: "Camunda BPMN workflow engine internals, interceptors, and state machine"
---

# Camunda

## bpmnè°ƒç”¨è¿‡ç¨‹

æœ¬éƒ¨åˆ†å†…å®¹ä½¿ç”¨ï¼šCamunda 7.23.0ç‰ˆæœ¬

```pom title="pom.xml" {4}
<dependency>
    <groupId>org.camunda.bpm.springboot</groupId>
    <artifactId>camunda-bpm-spring-boot-starter</artifactId>
    <version>7.23.0</version>
</dependency>
```

è¿½è¸ªè°ƒç”¨è¿‡ç¨‹ä½¿ç”¨[é¡¹ç›®åœ°å€](https://github.com/Halcyon666/camunda-springboot)

### å¯åŠ¨è¿‡ç¨‹

```java title="HelloProcessController" {4}
@RestController
public class HelloProcessController {

    private final RuntimeService runtimeService;
    private final TaskService taskService;
    // other codes ...
}
```

ç”±äºä¾èµ–äº†`RuntimeService`ï¼Œè§¦å‘SpringBootè‡ªåŠ¨è£…é…Camundaç›¸å…³çš„é…ç½®ç±»ã€‚


```mermaid
graph
    A["Controller RuntimeService"]
    A --> B["SpringProcessEngineServicesConfiguration#getRuntimeService"]
    B --> C["åˆå§‹åŒ–ProcessEngine"]
    C --> D["åˆå§‹åŒ–ProcessEngineConfigurationImpl=>CamundaBpmConfiguration#processEngineConfigurationImpl"å¹¶æŒæœ‰æ‰€æœ‰çš„ProcessEnginePlugin]
    D --> E["CamundaBpmAutoConfiguration$ProcessEngineConfigurationImplDependingConfiguration.processEngineFactoryBean()"]
    E --> F["FactoryBeanRegistrySupport#doGetObjectFromFactoryBean"]
    F --> G["ProcessEngineFactoryBean#getObject"]
    G --> H["ProcessEngineConfigurationImpl#buildProcessEngine"]
    H --> å…¶ä»–è£…é…åŠ¨ä½œ
```

:::info
æ€»é…ç½®ç±» `org.camunda.bpm.spring.boot.starter.CamundaBpmAutoConfiguration`

åœ¨ `org.camunda.bpm.spring.boot.starter.CamundaBpmConfiguration` ä¸­åˆ›å»º`ProcessEngineConfigurationImpl` 

â‡’ `org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl` ä¸»è¦æ˜¯åˆå§‹åŒ–ä¸€å †plugin

â‡’ `org.camunda.bpm.engine.spring.ProcessEngineFactoryBean` åˆ›å»º`org.camunda.bpm.engine.ProcessEngine`çš„`FactoryBean`ï¼Œä½¿ç”¨`ProcessEngineConfigurationImpl` 

æ„å»ºå¼•æ“ `org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl#buildProcessEngine`

`org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl#invokePreInit`
:::

### Interceptorè°ƒç”¨é“¾åˆ†æ

`org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl#getDefaultCommandInterceptorsTxRequired`
`public abstract class CommandInterceptor implements CommandExecutor`

`org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl`ç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§
`protected List<CommandInterceptor> commandInterceptorsTxRequired;`, æ‰€æœ‰è¿™äº›`CommandInterceptors`éƒ½æ˜¯`CommandExecutor`ã€‚

åœ¨ `org.camunda.bpm.engine.impl.cfg.ProcessEngineConfigurationImpl#initCommandExecutorTxRequired`  `Line 1586`è¡Œä¸­åˆå§‹åŒ–ã€‚
ä»åå¾€å‰ï¼ŒæŠŠä¸€ä¸ªä¸ªInterceptoré“¾æ¥èµ·æ¥ï¼Œç„¶åå°†ç¬¬ä¸€ä¸ªèµ‹å€¼ç»™commandExecutorTxRequiresNewã€‚

```java title="ProcessEngineConfigurationImpl" 
/**
 * this will be initialized during the configurationComplete()
 */
protected CommandExecutor commandExecutorTxRequiresNew;
protected void initCommandExecutorTxRequired() {
  if (commandExecutorTxRequired == null) {
    commandExecutorTxRequired = initInterceptorChain(commandInterceptorsTxRequired);
  }
}
protected CommandInterceptor initInterceptorChain(List<CommandInterceptor> chain) {
  if (chain == null || chain.isEmpty()) {
    throw new ProcessEngineException("invalid command interceptor chain configuration: " + chain);
  }
  for (int i = 0; i < chain.size() - 1; i++) {
    chain.get(i).setNext(chain.get(i + 1));
  }
  return chain.get(0);
}
```

å…·ä½“æœ‰å“ªäº›Interceptorså‘¢ï¼Ÿ

![20251011232211](https://s2.loli.net/2025/10/11/JqhVdHAg8p9D32B.png)

### åˆå§‹åŒ–äº†å“ªäº›Service

```java title="ProcessEngineConfigurationImpl"
protected RepositoryService repositoryService = new RepositoryServiceImpl();
protected RuntimeService runtimeService = new RuntimeServiceImpl();
protected HistoryService historyService = new HistoryServiceImpl();
protected IdentityService identityService = new IdentityServiceImpl();
protected TaskService taskService = new TaskServiceImpl();
protected FormService formService = new FormServiceImpl();
protected ManagementService managementService = new ManagementServiceImpl(this);
protected AuthorizationService authorizationService = new AuthorizationServiceImpl();
protected CaseService caseService = new CaseServiceImpl();
protected FilterService filterService = new FilterServiceImpl();
protected ExternalTaskService externalTaskService = new ExternalTaskServiceImpl();
protected DecisionService decisionService = new DecisionServiceImpl();
protected OptimizeService optimizeService = new OptimizeService();
```

## å¦‚ä½•è°ƒç”¨è¿™ä¸ªç±»

### åå°„

<details>
    <summary>åå°„</summary>
```xml title="hello-process.bpmn"
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             targetNamespace="Examples">
  <process id="helloProcess"
           name="Hello Process"
           isExecutable="true"
           camunda:historyTimeToLive="180">
    <startEvent id="StartEvent_1" />
    <sequenceFlow id="flow1" sourceRef="StartEvent_1" targetRef="ServiceTask_1"/>
    <serviceTask id="ServiceTask_1"
                 name="Say Hello"
                 // highlight-next-line
                 camunda:class="com.example.camunda.delegate.HelloDelegate" />
    <sequenceFlow id="flow2" sourceRef="ServiceTask_1" targetRef="UserTask_1"/>
    <userTask id="UserTask_1" name="å®¡æ‰¹ä¸€ä¸‹" />
    <sequenceFlow id="flow3" sourceRef="UserTask_1" targetRef="EndEvent_1"/>
    <endEvent id="EndEvent_1" />

  </process>
</definitions>
```

```java
@Slf4j
public class HelloDelegate implements JavaDelegate {
    @Override
    public void execute(DelegateExecution execution) {
        log.info("Hello from Camunda Delegate! processInstanceId={}", execution.getProcessInstanceId());
        execution.setVariable("greeting", "hello from delegate");
    }
}
```
</details>

`camunda:class="com.example.camunda.delegate.HelloDelegate"` è¡¨æ˜äº†é€šè¿‡åå°„è°ƒç”¨ï¼ŒçœŸå®è°ƒç”¨ä»£ç ä½ç½®
`ClassDelegateActivityBehavior#getActivityBehaviorInstance(ActivityExecution)`

### é€šè¿‡springå®¹å™¨

- delegateExpression: é€‚åˆéœ€è¦å®ç° JavaDelegate æ¥å£çš„åœºæ™¯,æ›´ç¬¦åˆ Camunda è§„èŒƒ
`camunda:delegateExpression="${helloDelegate}"`

<details>
    <summary>delegateExpression</summary>
```xml title="hello-process.bpmn"
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             targetNamespace="Examples">
  <process id="helloProcess"
           name="Hello Process"
           isExecutable="true"
           camunda:historyTimeToLive="180">
    <startEvent id="StartEvent_1" />
    <sequenceFlow id="flow1" sourceRef="StartEvent_1" targetRef="ServiceTask_1"/>
    <serviceTask id="ServiceTask_1"
                 name="Say Hello"
                 camunda:delegateExpression="${helloDelegate}" />
    <sequenceFlow id="flow2" sourceRef="ServiceTask_1" targetRef="UserTask_1"/>
    <userTask id="UserTask_1" name="å®¡æ‰¹ä¸€ä¸‹" />
    <sequenceFlow id="flow3" sourceRef="UserTask_1" targetRef="EndEvent_1"/>
    <endEvent id="EndEvent_1" />

  </process>
</definitions>
```

```java title="HelloDelegate"
@Slf4j
@Component
// highlight-next-line
public class HelloDelegate implements JavaDelegate {
    @Override
    public void execute(DelegateExecution execution) {
        log.info("Hello from Camunda Delegate! processInstanceId={}", execution.getProcessInstanceId());
        execution.setVariable("greeting", "hello from delegate");
    }
}
```
</details>

- expression: æ›´çµæ´»,å¯ä»¥ç›´æ¥è°ƒç”¨ Spring Bean çš„ä»»æ„æ–¹æ³•,ä¸éœ€è¦å®ç°ç‰¹å®šæ¥å£
`camunda:expression="${helloDelegate1.sayHello(execution)}`

<details>
    <summary>expressionæ–¹å¼</summary>
```xml title="hello-process.bpmn"
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             targetNamespace="Examples">

  <process id="helloProcess"
           name="Hello Process"
           isExecutable="true"
           camunda:historyTimeToLive="180">
    <startEvent id="StartEvent_1" />
    <sequenceFlow id="flow1" sourceRef="StartEvent_1" targetRef="ServiceTask_1"/>
    <serviceTask id="ServiceTask_1"
                 name="Say Hello"
                 // highlight-next-line
                 camunda:expression="${helloDelegate1.sayHello(execution)}" />
    <sequenceFlow id="flow2" sourceRef="ServiceTask_1" targetRef="UserTask_1"/>
    <userTask id="UserTask_1" name="å®¡æ‰¹ä¸€ä¸‹" />
    <sequenceFlow id="flow3" sourceRef="UserTask_1" targetRef="EndEvent_1"/>
    <endEvent id="EndEvent_1" />
  </process>
</definitions>
```
```java
@Component title="HelloDelegate1"
public class HelloDelegate1 {
    private static final Logger log = LoggerFactory.getLogger(HelloDelegate1.class);
    // highlight-next-line
    public void sayHello(DelegateExecution execution) {
        // ä½¿ç”¨æ³¨å…¥çš„æœåŠ¡
        log.info("Hello from Camunda Delegate! processInstanceId={}", execution.getProcessInstanceId());
        execution.setVariable("greeting1", "hello from delegate");
    }
}

```
</details>

## å¥‡æ€ªçš„debugæ‰‹æ®µ

æ¯”å¦‚æƒ³åœ¨jaråŒ…ä¸­çš„AbstractEventAtomicOperationç¬¬50è¡Œæ‰“å°æ§åˆ¶å°æ—¥å¿—ã€‚

ä½¿ç”¨condition debugå¹¶ä¸”å–æ¶ˆsuspendã€‚

ç•Œé¢æ•ˆæœå¦‚ä¸‹:

```java
System.out.println(String.format("[%s] %s", ((org.camunda.bpm.engine.impl.pvm.runtime.PvmExecutionImpl)execution).getCurrentActivityId(), this.getClass().getSimpleName())) == null
```
![20251012001135](https://s2.loli.net/2025/10/12/lG1Dz4cXSsF8KVO.png)

## çŠ¶æ€æœºçŠ¶æ€è½¬åŒ–è¿‡ç¨‹ 

```log
performOperation(CoreAtomicOperation):609, ExecutionEntity (org.camunda.bpm.engine.impl.persistence.entity), ExecutionEntity.java
// highlight-start
callback(PvmExecutionImpl):75, PvmAtomicOperationProcessStart$2 (org.camunda.bpm.engine.impl.pvm.runtime.operation), PvmAtomicOperationProcessStart.java
callback(Object):70, PvmAtomicOperationProcessStart$2 (org.camunda.bpm.engine.impl.pvm.runtime.operation), PvmAtomicOperationProcessStart.java
continueIfExecutionDoesNotAffectNextOperation(Callback, Callback, PvmExecutionImpl):2109, PvmExecutionImpl (org.camunda.bpm.engine.impl.pvm.runtime), PvmExecutionImpl.java
eventNotificationsCompleted(PvmExecutionImpl):64, PvmAtomicOperationProcessStart (org.camunda.bpm.engine.impl.pvm.runtime.operation), PvmAtomicOperationProcessStart.java
eventNotificationsCompleted(CoreExecution):30, PvmAtomicOperationProcessStart (org.camunda.bpm.engine.impl.pvm.runtime.operation), PvmAtomicOperationProcessStart.java
execute(CoreExecution):70, AbstractEventAtomicOperation (org.camunda.bpm.engine.impl.core.operation), AbstractEventAtomicOperation.
// highlight-end
execute(BpmnStackTrace, ProcessDataContext):99, AtomicOperationInvocation (org.camunda.bpm.engine.impl.interceptor), AtomicOperationInvocation.java
invokeNext():141, CommandInvocationContext (org.camunda.bpm.engine.impl.interceptor), CommandInvocationContext.java
performNext():128, CommandInvocationContext (org.camunda.bpm.engine.impl.interceptor), CommandInvocationContext.java
performOperation(AtomicOperation, ExecutionEntity, boolean):96, CommandInvocationContext (org.camunda.bpm.engine.impl.interceptor), CommandInvocationContext.java [1]
performOperation(AtomicOperation):635, ExecutionEntity (org.camunda.bpm.engine.impl.persistence.entity), ExecutionEntity.java
performOperation(CoreAtomicOperation):609, ExecutionEntity (org.camunda.bpm.engine.impl.persistence.entity), ExecutionEntity.java
start(Map, VariableMap):294, PvmExecutionImpl (org.camunda.bpm.engine.impl.pvm.runtime), PvmExecutionImpl.java
```

### start-hello task

<details>
    <summary>Controleræ¥å£</summary>
```java
package com.example.camunda.web;

import org.camunda.bpm.engine.RuntimeService;
import org.camunda.bpm.engine.TaskService;
import org.camunda.bpm.engine.runtime.ProcessInstance;
import org.camunda.bpm.engine.task.Task;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
public class HelloProcessController {

    private final RuntimeService runtimeService;
    private final TaskService taskService;

    public HelloProcessController(RuntimeService runtimeService, TaskService taskService) {
        this.runtimeService = runtimeService;
        this.taskService = taskService;
    }

    // å¯åŠ¨æµç¨‹
    @GetMapping("/start-hello")
    public String startHelloProcess() {
        ProcessInstance instance = runtimeService.startProcessInstanceByKey("helloProcess");
        return "æµç¨‹å¯åŠ¨æˆåŠŸï¼Œå®ä¾‹ID: " + instance.getId();
    }

    // æŸ¥è¯¢å½“å‰å¾…åŠä»»åŠ¡
    @GetMapping("/tasks")
    public String listTasks() {
        List<Task> tasks = taskService.createTaskQuery().list();
        if (tasks.isEmpty()) {
            return "å½“å‰æ²¡æœ‰å¾…åŠä»»åŠ¡";
        }
        StringBuilder sb = new StringBuilder("å¾…åŠä»»åŠ¡åˆ—è¡¨ï¼š\n");
        for (Task task : tasks) {
            sb.append("ä»»åŠ¡ID=").append(task.getId())
              .append(", åç§°=").append(task.getName())
              .append(", æµç¨‹å®ä¾‹ID=").append(task.getProcessInstanceId())
              .append("\n");
        }
        return sb.toString();
    }

    // å®Œæˆä»»åŠ¡
    @PostMapping("/complete/{taskId}")
    public String completeTask(@PathVariable String taskId) {
        taskService.complete(taskId);
        return "ä»»åŠ¡å·²å®Œæˆ: " + taskId;
    }
}
```
</details>

```shell 
GET http://localhost:8080/start-hello
```
åœ¨ `org.camunda.bpm.engine.impl.persistence.entity.ExecutionEntity#performOperation(org.camunda.bpm.engine.impl.core.operation.CoreAtomicOperation<T>)` <br/>
å¤„ä½¿ç”¨æ¡ä»¶æ–­ç‚¹,æ–­ç‚¹æ‰“å°ä¿¡æ¯å¦‚ä¸‹
```java
System.out.println(String.format("[ActivityId: %s] Operation: %s, Thread: %s", 
    this.activityId != null ? this.activityId : "ROOT",
    operation.getClass().getSimpleName(),
    Thread.currentThread().getName())) == null
```

```log title="start-hello å»é‡ä¹‹åçš„æ—¥å¿—"
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationProcessStart, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationActivityStartCreateScope, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationActivityStart, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationActivityExecute, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationActivityLeave, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationTransitionNotifyListenerEnd, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationTransitionDestroyScope, Thread: http-nio-8080-exec-7
[ActivityId: StartEvent_1] Operation: PvmAtomicOperationTransitionNotifyListenerTake, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationTransitionCreateScope, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationTransitionNotifyListenerStart, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationActivityExecute, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationActivityLeave, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationTransitionNotifyListenerEnd, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationTransitionDestroyScope, Thread: http-nio-8080-exec-7
[ActivityId: ServiceTask_1] Operation: PvmAtomicOperationTransitionNotifyListenerTake, Thread: http-nio-8080-exec-7
[ActivityId: UserTask_1] Operation: PvmAtomicOperationTransitionCreateScope, Thread: http-nio-8080-exec-7
[ActivityId: UserTask_1] Operation: PvmAtomicOperationTransitionNotifyListenerStart, Thread: http-nio-8080-exec-7
[ActivityId: UserTask_1] Operation: PvmAtomicOperationActivityExecute, Thread: http-nio-8080-exec-7
```

### complete task

```shell
POST http://localhost:8080/complete/55e03f1c-a5f7-11f0-9020-b05cda36f80c
Content-Type: application/x-www-form-urlencoded
```

```log title="complete å»é‡ä¹‹åçš„æ—¥å¿—"
[ActivityId: UserTask_1] Operation: PvmAtomicOperationActivityLeave, Thread: http-nio-8080-exec-10
[ActivityId: UserTask_1] Operation: PvmAtomicOperationTransitionNotifyListenerEnd, Thread: http-nio-8080-exec-10
[ActivityId: UserTask_1] Operation: PvmAtomicOperationTransitionDestroyScope, Thread: http-nio-8080-exec-10
[ActivityId: UserTask_1] Operation: PvmAtomicOperationTransitionNotifyListenerTake, Thread: http-nio-8080-exec-10
[ActivityId: EndEvent_1] Operation: PvmAtomicOperationTransitionCreateScope, Thread: http-nio-8080-exec-10
[ActivityId: EndEvent_1] Operation: PvmAtomicOperationTransitionNotifyListenerStart, Thread: http-nio-8080-exec-10
[ActivityId: EndEvent_1] Operation: PvmAtomicOperationActivityExecute, Thread: http-nio-8080-exec-10
[ActivityId: EndEvent_1] Operation: PvmAtomicOperationActivityNotifyListenerEnd, Thread: http-nio-8080-exec-10
[ActivityId: EndEvent_1] Operation: PvmAtomicOperationActivityEnd, Thread: http-nio-8080-exec-10
[ActivityId: EndEvent_1] Operation: PvmAtomicOperationProcessEnd, Thread: http-nio-8080-exec-10
```

import TailProtocal from '@site/src/components/TailProtocal'

<TailProtocal />

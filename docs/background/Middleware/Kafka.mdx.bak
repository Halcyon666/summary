---
title: "Kafka"
sidebar_label: "ğŸ“¨ Kafka"
sidebar_position: 1
description: "Kafka deployment, Docker Compose, and Spring Boot integration"
---

# Kafka

## å¦‚ä½•ä½¿ç”¨Docker Composeéƒ¨ç½²Kafka

:::info
å€Ÿé‰´github[ä»“åº“](https://github.com/conduktor/kafka-stack-docker-compose/tree/master)<br/>
ä¸‹é¢ç¤ºä¾‹ä½¿ç”¨æœ€ç®€å•çš„ `zk-single-kafka-single.yml`
:::


ä»¥ä¸‹ä¸ºæ­£ç¡®ç¤ºä¾‹ï¼š

å¯¹ä»“åº“ä¸­çš„æ–‡ä»¶ä½œäº†ä¸¤å¤„è°ƒæ•´

- è°ƒæ•´äº†è¿æ¥åœ°å€

```diff
-  KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka1:19092,EXTERNAL://${DOCKER_HOST_IP:-127.0.0.1}:9092,DOCKER://host.docker.internal:29092
+  KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka1:19092,EXTERNAL://${DOCKER_HOST_IP:-192.168.3.163}:9092,DOCKER://host.docker.internal:29092
```
- åœ¨Zoo1å’Œkafka1ä¸­éƒ½æ·»åŠ äº†æ—¶åŒºï¼Œå¯ä»¥è§£å†³æ—¶é—´ä¸å¯¹çš„é—®é¢˜

```diff 
+      TZ: Asia/Shanghai
```

<details>
  <summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹å®Œæ•´é…ç½®æ–‡ä»¶</summary>
```yml
version: '2.1'

services:
  zoo1:
    image: confluentinc/cp-zookeeper:7.3.2
    hostname: zoo1
    container_name: zoo1
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_SERVERS: zoo1:2888:3888
      TZ: Asia/Shanghai

  kafka1:
    image: confluentinc/cp-kafka:7.3.2
    hostname: kafka1
    container_name: kafka1
    ports:
      - "9092:9092"
      - "29092:29092"
      - "9999:9999"
    environment:
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka1:19092,EXTERNAL://${DOCKER_HOST_IP:-192.168.3.163}:9092,DOCKER://host.docker.internal:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,DOCKER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_ZOOKEEPER_CONNECT: "zoo1:2181"
      KAFKA_BROKER_ID: 1
      KAFKA_LOG4J_LOGGERS: "kafka.controller=INFO,kafka.producer.async.DefaultEventHandler=INFO,state.change.logger=INFO"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_JMX_PORT: 9999
      KAFKA_JMX_HOSTNAME: ${DOCKER_HOST_IP:-127.0.0.1}
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: "true"
      TZ: Asia/Shanghai
    depends_on:
      - zoo1
```

</details>

### æŠ¥é”™ could not be established. Broker may not be available

è°ƒæ•´å¤–éƒ¨è¿æ¥åœ°å€å³å¯è§£å†³é—®é¢˜

```log
[| adminclient-1] org.apache.kafka.clients.NetworkClient : [AdminClient clientId=adminclient-1] 
Connection to node 1 (/127.0.0.1:9092) could not be established. Broker may not be available.
```

## å¦‚ä½•ä½¿ç”¨å‘½ä»¤è¡Œæ“ä½œé›†ç¾¤

```shell
# åˆ›å»ºtopic
docker run --rm --network=host \
           confluentinc/cp-kafka:7.3.2 \
           kafka-topics --bootstrap-server=127.0.0.1:9092 \
                        --create \
                        --topic=my-topic \
                        --partitions=3 \
                        --replication-factor=1
# ç”Ÿäº§æ¶ˆæ¯
docker run --tty --interactive \
           --rm \
           --network=host \
           confluentinc/cp-kafka:7.3.2 \
           kafka-console-producer --broker-list=127.0.0.1:9092 --topic=my-topic
           
# æ¶ˆè´¹æ¶ˆæ¯  
docker run --tty --interactive \
           --rm \
           --network=host \
           confluentinc/cp-kafka:7.3.2 \
           kafka-console-consumer --bootstrap-server=127.0.0.1:9092 --topic=my-topic
		   
```

## å¦‚ä½•åœ¨Spring Bootä¸­ä½¿ç”¨Kafka

[å‚è€ƒèµ„æ–™](https://www.baeldung.com/spring-kafka)

[å‚è€ƒä»“åº“ä»£ç ](https://github.com/Halcyon666/kafka-learn)

ä»“åº“ä»£ç ç®€å•ä»‹ç»äº† Kafkaåˆ›å»ºå­—ç¬¦ä¸²æ¶ˆæ¯å’ŒPojoæ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯çš„ç¤ºä¾‹ã€‚

å‚è€ƒèµ„æ–™æ¶‰åŠå¤šç§ç±»å‹æ¶ˆæ¯æ··åˆç”Ÿäº§å’Œæ¶ˆè´¹ã€‚å€¼å¾—å­¦ä¹ å’Œå€Ÿé‰´ã€‚

## ç”Ÿäº§è€…ä½¿ç”¨æ³¨æ„ç‚¹

1. ä¸€ä¸ªJVMä¸‹ä½¿ç”¨ä¸€ä¸ªç”Ÿäº§è€…å³å¯ï¼Œå¤šä¸ªç”Ÿäº§è€…å¯èƒ½OOMï¼Œä¸€ä¸ªç”Ÿäº§è€…`buffer.memory=32MB` ã€‚
2. Batchè®¾è®¡ï¼Œé¦–å…ˆçœ‹`batch.size` æ˜¯å¦æ»¡è¶³ï¼Œä¸æ»¡è¶³å†çœ‹`linger.ms` ,å½“ç¼“å­˜æ¶ˆæ¯åˆ°è¾¾`buffer.memory` ä¼šç›´æ¥è§¦å‘æ¶ˆæ¯å‘é€åˆ°æœåŠ¡å™¨ã€‚
3. acks, 0 -ä¸ç¡®è®¤ï¼Œ1-æ‰€æœ‰ä¸»èŠ‚ç‚¹å†™å…¥æˆåŠŸï¼Œall-æ‰€æœ‰èŠ‚ç‚¹å†™å…¥æˆåŠŸ


## è§¦å‘Coordinator Rebalance

- ç»„æˆå‘˜æ•°é‡å˜åŒ–
- è®¢é˜…ä¸»é¢˜æ•°é‡å˜åŒ–
- è®¢é˜…ä¸»é¢˜åˆ†åŒºæ•°å˜åŒ–

å»ºè®®
1. `session.timeout.ms > 3 * hearbeat.interval.ms`
2. æ§åˆ¶æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´ï¼Œä¸è¦è¶…è¿‡`max.poll.interval.ms`é…ç½®æ—¶é—´

import TailProtocal from "@site/src/components/TailProtocal";

<TailProtocal />

---
title: "MCP"
sidebar_label: "MCP"
sidebar_position: 5
description: "MCP åè®®è¯¦è§£"
---

# MCP 

## ä»€ä¹ˆæ˜¯ MCPï¼Ÿ

MCPï¼ˆModel Context Protocolï¼‰æ˜¯ä¸€ç§æ ‡å‡†åŒ–åè®®ï¼Œæ—¨åœ¨ç®€åŒ–å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ä¸å¤–éƒ¨æ•°æ®æºï¼ˆå¦‚æ•°æ®åº“ã€API ç­‰ï¼‰ä¹‹é—´çš„äº¤äº’ã€‚
é€šè¿‡ MCPï¼Œå¼€å‘è€…å¯ä»¥è®© LLM ä»¥ç»Ÿä¸€çš„æ–¹å¼è®¿é—®å’Œæ“ä½œå„ç§æ•°æ®æºï¼Œä»è€Œæå‡æ¨¡å‹çš„å®ç”¨æ€§å’Œæ‰©å±•æ€§ã€‚

## MCP çš„æ ¸å¿ƒç»„ä»¶

1. **MCP Server**ï¼šè´Ÿè´£å¤„ç†æ¥è‡ª LLM çš„è¯·æ±‚ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°ç›¸åº”çš„æ•°æ®æºã€‚å®ƒå……å½“ LLM å’Œå¤–éƒ¨ç³»ç»Ÿä¹‹é—´çš„ä¸­ä»‹ã€‚
2. **MCP Client**ï¼šé›†æˆåœ¨ LLM ä¸­ï¼Œç”¨äºå‘é€è¯·æ±‚åˆ° MCP Server å¹¶æ¥æ”¶å“åº”ã€‚
3. **æ•°æ®æºé€‚é…å™¨**ï¼šç”¨äºè¿æ¥ä¸åŒç±»å‹çš„æ•°æ®æºï¼ˆå¦‚ SQL æ•°æ®åº“ã€NoSQL æ•°æ®åº“ã€RESTful API ç­‰ï¼‰ï¼Œå¹¶å°†æ•°æ®è½¬æ¢ä¸º MCP å¯ç†è§£çš„æ ¼å¼ã€‚

## MCP çš„å·¥ä½œåŸç†

1. **è¯·æ±‚å‘é€**ï¼šLLM é€šè¿‡ MCP Client å‘é€è¯·æ±‚åˆ° MCP Serverï¼ŒæŒ‡å®šæ‰€éœ€çš„æ•°æ®æ“ä½œï¼ˆå¦‚æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ç­‰ï¼‰ã€‚
2. **è¯·æ±‚å¤„ç†**ï¼šMCP Server æ¥æ”¶åˆ°è¯·æ±‚åï¼Œè§£æè¯·æ±‚å†…å®¹ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„æ•°æ®æºé€‚é…å™¨ã€‚
3. **æ•°æ®æ“ä½œ**ï¼šæ•°æ®æºé€‚é…å™¨ä¸å¤–éƒ¨æ•°æ®æºè¿›è¡Œäº¤äº’ï¼Œæ‰§è¡Œæ‰€éœ€çš„æ“ä½œã€‚
4. **å“åº”è¿”å›**ï¼šæ“ä½œå®Œæˆåï¼Œæ•°æ®æºé€‚é…å™¨å°†ç»“æœè¿”å›ç»™ MCP Serverï¼Œåè€…å†å°†ç»“æœå‘é€å› LLMã€‚

## MCP çš„ä¼˜åŠ¿
- **æ ‡å‡†åŒ–æ¥å£**ï¼šé€šè¿‡ç»Ÿä¸€çš„åè®®ï¼Œç®€åŒ–äº† LLM ä¸å¤šç§æ•°æ®æºçš„é›†æˆè¿‡ç¨‹ã€‚
- **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒå¤šç§æ•°æ®æºç±»å‹ï¼Œä¾¿äºæœªæ¥æ‰©å±•å’Œé›†æˆæ–°çš„æ•°æ®æºã€‚
- **æé«˜æ•ˆç‡**ï¼šå‡å°‘äº†å¼€å‘è€…åœ¨é›†æˆæ•°æ®æºæ—¶çš„é‡å¤å·¥ä½œï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚
- **å¢å¼ºæ¨¡å‹èƒ½åŠ›**ï¼šä½¿ LLM èƒ½å¤Ÿè®¿é—®æ›´å¤šå®æ—¶å’Œç»“æ„åŒ–çš„æ•°æ®ï¼Œæå‡å…¶å›ç­”çš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§ã€‚

## MCP çš„åº”ç”¨åœºæ™¯
- **ä¼ä¸šçŸ¥è¯†åº“**ï¼šè®© LLM è®¿é—®ä¼ä¸šå†…éƒ¨æ•°æ®åº“ï¼Œæä¾›æ›´å‡†ç¡®çš„ä¸šåŠ¡å’¨è¯¢å’Œæ”¯æŒã€‚
- **åŠ¨æ€æ•°æ®æŸ¥è¯¢**ï¼šé€šè¿‡ MCP è¿æ¥å®æ—¶æ•°æ®æºï¼Œå¦‚è‚¡ç¥¨å¸‚åœºæ•°æ®ã€

å¤©æ°”ä¿¡æ¯ç­‰ï¼Œå¢å¼ºæ¨¡å‹çš„å®æ—¶å“åº”èƒ½åŠ›ã€‚
- **å¤šæ•°æ®æºæ•´åˆ**ï¼šåœ¨ä¸€ä¸ªåº”ç”¨ä¸­é›†æˆå¤šä¸ªæ•°æ®æºï¼Œå¦‚ CRM ç³»ç»Ÿã€ERP ç³»ç»Ÿç­‰ï¼Œæä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£ã€‚
- **å®šåˆ¶åŒ–åº”ç”¨**ï¼šæ ¹æ®ç‰¹å®šä¸šåŠ¡éœ€æ±‚ï¼Œå®šåˆ¶åŒ–å¼€å‘ MCP é€‚é…å™¨ï¼Œå®ç°ç‰¹å®šåŠŸèƒ½çš„æ•°æ®äº¤äº’ã€‚
------

## å®è·µç¤ºä¾‹

### MCP Server ç®€å•å®ç°
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ MCP Server å®ç°ç¤ºä¾‹ï¼Œä½¿ç”¨ FastAPI æ¡†æ¶ï¼š

```python
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("Simple-Math-Server")


@mcp.tool()
def add_numbers(a: int, b: int) -> dict:
    """Add two numbers together and return a structured object."""
    total = a + b

    # Return a dictionary that matches your desired "properties" structure
    return {
        "result": total
    }


if __name__ == "__main__":
    mcp.run()
```



### ä½¿ç”¨claude desktop appè°ƒç”¨MCP Server

claude mcp é…ç½®

```json
{
  "mcpServers": {
    "my-math-tool": {
      "command": "python",
      "args": ["D:/project/PycharmProjects/fastApiProject/mcp-server.py"]
    }
  }
}
```

File Location:

Mac: `~/Library/Application Support/Claude/claude_desktop_config.json`

Windows: `%APPDATA%\Claude\claude_desktop_config.json`



çœç•¥...

### ä½¿ç”¨MCP Inspectoræ¥è°ƒç”¨MCP Server

1. å¯åŠ¨MCP Serverï¼š

```command
npx @modelcontextprotocol/inspector python mcp-server.py 
```

:::tip
`pip install mcp` åº”è¯¥å®‰è£…åœ¨å…¨å±€ç¯å¢ƒï¼Œä¸èƒ½åªåœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ï¼Œå¦åˆ™ Claude æ‰¾ä¸åˆ° MCP åŒ…ã€‚
:::

2. åœ¨ç½‘é¡µä¸­è¿æ¥

![20260118205955](https://s2.loli.net/2026/01/18/wzAijy7YTvnCkoR.png)

3. è°ƒç”¨ `add_numbers` æ–¹æ³•

![20260118210144](https://s2.loli.net/2026/01/18/xqip2LnU1B9aFgS.png)

### ä½¿ç”¨langchainè°ƒç”¨MCP Server

<details>
<summary>mcp-client.py</summary>
```python
import asyncio
import sys
import operator
from typing import Annotated, TypedDict, List

# MCP SDK
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

# LangChain / LangGraph
from langchain_ollama import ChatOllama
from langchain_core.tools import StructuredTool
from langchain_core.messages import BaseMessage, HumanMessage, ToolMessage
from langgraph.graph import StateGraph, END

# --- 1. å®šä¹‰çŠ¶æ€ ---
class AgentState(TypedDict):
    messages: Annotated[List[BaseMessage], operator.add]

# --- 2. è½¬æ¢å™¨ï¼šæŠŠ MCP å·¥å…·å˜æˆ LangChain å·¥å…· ---
def mcp_to_langchain(mcp_tool, session):
    async def _tool_func(**kwargs):
        # è°ƒç”¨ MCP Server
        result = await session.call_tool(mcp_tool.name, arguments=kwargs)
        # æå–ç»“æœæ–‡æœ¬
        if result.content and result.content[0].type == "text":
            return result.content[0].text
        return str(result)

    return StructuredTool.from_function(
        func=None,
        coroutine=_tool_func, # LangChain æ”¯æŒå¼‚æ­¥å·¥å…·
        name=mcp_tool.name,
        description=mcp_tool.description
    )

# --- 3. ä¸»ç¨‹åº ---
async def main():
    # é…ç½®æœåŠ¡å™¨å¯åŠ¨å‚æ•° (ç¡®ä¿ server.py å’Œ client.py åœ¨åŒä¸€ç›®å½•)
    server_params = StdioServerParameters(
        command=sys.executable, 
        args=["D:/project/PycharmProjects/fastApiProject/mcp-server.py"], 
        env=None
    )

    print("ğŸ”Œ Client: æ­£åœ¨è¿æ¥ MCP Server...")

    # å»ºç«‹è¿æ¥
    async with stdio_client(server_params) as (read, write):
        async with ClientSession(read, write) as session:
            # åˆå§‹åŒ–
            await session.initialize()
            
            # è·å–å·¥å…·
            tools_data = await session.list_tools()
            mcp_tools = tools_data.tools
            print(f"ğŸ› ï¸  Client: å‘ç°å·¥å…· -> {[t.name for t in mcp_tools]}")

            # è½¬æ¢å·¥å…·ç»™ LangChain
            lc_tools = [mcp_to_langchain(t, session) for t in mcp_tools]

            # åˆå§‹åŒ– LLM (ç¡®ä¿ä½ çš„ Ollama å·²ç» pull äº† llama3.1 æˆ– qwen2.5)
            llm = ChatOllama(model="llama3.1", temperature=0)
            llm_with_tools = llm.bind_tools(lc_tools)

            # --- æ„å»º LangGraph ---

            async def call_model(state: AgentState):
                # è°ƒç”¨ LLM
                response = await llm_with_tools.ainvoke(state["messages"])
                return {"messages": [response]}

            async def call_tools(state: AgentState):
                last_message = state["messages"][-1]
                results = []
                for call in last_message.tool_calls:
                    print(f"ğŸ¤– Agent: å†³å®šè°ƒç”¨å·¥å…· '{call['name']}' å‚æ•°: {call['args']}")
                    
                    # æŸ¥æ‰¾å¹¶æ‰§è¡Œå·¥å…·
                    tool = next((t for t in lc_tools if t.name == call['name']), None)
                    if tool:
                        output = await tool.coroutine(**call['args'])
                        print(f"âœ… Agent: å·¥å…·è¿”å›ç»“æœ -> {output}")
                        
                        results.append(ToolMessage(
                            content=output,
                            tool_call_id=call["id"],
                            name=call["name"]
                        ))
                return {"messages": results}

            # å®šä¹‰å›¾ç»“æ„
            workflow = StateGraph(AgentState)
            workflow.add_node("llm", call_model)
            workflow.add_node("tools", call_tools)
            workflow.set_entry_point("llm")

            # æ¡ä»¶è¾¹ï¼šæœ‰ tool_calls å°±å» toolsï¼Œå¦åˆ™ç»“æŸ
            workflow.add_conditional_edges(
                "llm",
                lambda s: "tools" if s["messages"][-1].tool_calls else END
            )
            workflow.add_edge("tools", "llm")

            agent = workflow.compile()

            # --- è¿è¡Œæµ‹è¯• ---
            query = "è¯·è®¡ç®— 100 åŠ ä¸Š 55 ç­‰äºå¤šå°‘ï¼Ÿ"
            print(f"\nğŸ‘¤ ç”¨æˆ·: {query}")
            print("-" * 50)

            inputs = {"messages": [HumanMessage(content=query)]}
            
            # è¿è¡Œå›¾
            async for chunk in agent.astream(inputs, stream_mode="values"):
                # åªæ‰“å°æ¯ä¸€æ­¥æœ€åä¸€æ¡æ¶ˆæ¯çš„å†…å®¹
                msg = chunk["messages"][-1]
                # print(f"[{msg.type}]: {msg.content}") 

            # æ‰“å°æœ€ç»ˆå›å¤
            print("-" * 50)
            print(f"ğŸ’¡ æœ€ç»ˆç­”æ¡ˆ: {chunk['messages'][-1].content}")

if __name__ == "__main__":
    asyncio.run(main())
    
```
</details>

è¾“å‡ºï¼š

```log

ğŸ”Œ Client: æ­£åœ¨è¿æ¥ MCP Server...
ğŸ› ï¸  Client: å‘ç°å·¥å…· -> ['add_numbers']

ğŸ‘¤ ç”¨æˆ·: è¯·è®¡ç®— 100 åŠ ä¸Š 55 ç­‰äºå¤šå°‘ï¼Ÿ
--------------------------------------------------
ğŸ¤– Agent: å†³å®šè°ƒç”¨å·¥å…· 'add_numbers' å‚æ•°: {'a': 100, 'b': 55}
âœ… Agent: å·¥å…·è¿”å›ç»“æœ -> {
  "result": 155
}
--------------------------------------------------
ğŸ’¡ æœ€ç»ˆç­”æ¡ˆ: 100 åŠ ä¸Š 55 ç­‰äº 155ã€‚
    
```

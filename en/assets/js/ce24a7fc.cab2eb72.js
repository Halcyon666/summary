"use strict";(self.webpackChunksummary=self.webpackChunksummary||[]).push([["4045"],{62532(e,n,r){r.r(n),r.d(n,{metadata:()=>a,default:()=>h,frontMatter:()=>c,contentTitle:()=>o,toc:()=>d,assets:()=>l});var a=JSON.parse('{"id":"background/Java/JavaBase/trace","title":"Jaeger Trace MDC","description":"Simple Demo Code","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/background/Java/JavaBase/trace.mdx","sourceDirName":"background/Java/JavaBase","slug":"/background/Java/JavaBase/trace","permalink":"/en/background/Java/JavaBase/trace","draft":false,"unlisted":false,"editUrl":"https://github.com/Halcyon666/summary/edit/main/docs/background/Java/JavaBase/trace.mdx","tags":[{"inline":true,"label":"algorithm","permalink":"/en/tags/algorithm"},{"inline":true,"label":"computer-science","permalink":"/en/tags/computer-science"},{"inline":true,"label":"data-structures","permalink":"/en/tags/data-structures"}],"version":"current","lastUpdatedBy":"halcyon666","lastUpdatedAt":1769299200000,"sidebarPosition":10,"frontMatter":{"id":"trace","title":"Jaeger Trace MDC","sidebar_label":"Jaeger Trace MDC","sidebar_position":10,"description":"Simple Demo Code","tags":["algorithm","computer-science","data-structures"],"last_update":{"date":"2026-01-25","author":"halcyon666"},"sources":["spring-core"]},"sidebar":"tutorialSidebar","previous":{"title":"netty","permalink":"/en/background/Java/JavaBase/netty"},"next":{"title":"\u{1F4BC} Interview Cases","permalink":"/en/category/-interview-cases"}}'),t=r(62615),i=r(77545),s=r(4040);let c={id:"trace",title:"Jaeger Trace MDC",sidebar_label:"Jaeger Trace MDC",sidebar_position:10,description:"Simple Demo Code",tags:["algorithm","computer-science","data-structures"],last_update:{date:"2026-01-25",author:"halcyon666"},sources:["spring-core"]},o="Jaeger Trace MDC",l={},d=[{value:"1. Solution Overview",id:"1-solution-overview",level:2},{value:"1.1 Background and Objectives",id:"11-background-and-objectives",level:3},{value:"1.2 Core Value",id:"12-core-value",level:3},{value:"2. Architecture Design",id:"2-architecture-design",level:2},{value:"2.1 Overall Architecture Diagram",id:"21-overall-architecture-diagram",level:3},{value:"2.2 Core Component Description",id:"22-core-component-description",level:3},{value:"2.2.1 CustomMDCScopeManager",id:"221-custommdcscopemanager",level:4},{value:"2.2.2 CustomMDCScope",id:"222-custommdcscope",level:4},{value:"3. Key Process Design",id:"3-key-process-design",level:2},{value:"3.1 Process of Receiving Remote Trace Context",id:"31-process-of-receiving-remote-trace-context",level:3},{value:"3.2 MDC Management Process for Nested Spans",id:"32-mdc-management-process-for-nested-spans",level:3},{value:"3.3 Trace ID Split Algorithm",id:"33-trace-id-split-algorithm",level:3},{value:"4. Configuration and Integration",id:"4-configuration-and-integration",level:2},{value:"4.1 Tracer Initialization Configuration",id:"41-tracer-initialization-configuration",level:3},{value:"4.2 Logback Configuration",id:"42-logback-configuration",level:3},{value:"4.3 Spring Boot Integration (Optional)",id:"43-spring-boot-integration-optional",level:3},{value:"5. Usage Scenarios and Best Practices",id:"5-usage-scenarios-and-best-practices",level:2},{value:"5.1 Receive Upstream Trace Context",id:"51-receive-upstream-trace-context",level:3},{value:"5.2 Pass Trace Context Downstream",id:"52-pass-trace-context-downstream",level:3},{value:"5.3 Async Scenario Handling",id:"53-async-scenario-handling",level:3},{value:"6. Key Design Decisions",id:"6-key-design-decisions",level:2},{value:"6.1 Why not operate MDC directly in business code?",id:"61-why-not-operate-mdc-directly-in-business-code",level:3},{value:"6.2 Why need to save MDC snapshot?",id:"62-why-need-to-save-mdc-snapshot",level:3},{value:"6.3 Why use ThreadLocal instead of InheritableThreadLocal?",id:"63-why-use-threadlocal-instead-of-inheritablethreadlocal",level:3},{value:"7. Monitoring and Debugging",id:"7-monitoring-and-debugging",level:2},{value:"7.1 Log Output Example",id:"71-log-output-example",level:3},{value:"7.2 Jaeger UI Query",id:"72-jaeger-ui-query",level:3},{value:"7.3 Common Troubleshooting",id:"73-common-troubleshooting",level:3},{value:"8. Performance Considerations",id:"8-performance-considerations",level:2},{value:"8.1 Performance Impact Analysis",id:"81-performance-impact-analysis",level:3},{value:"8.2 Optimization Suggestions",id:"82-optimization-suggestions",level:3},{value:"9. Extension Directions",id:"9-extension-directions",level:2},{value:"9.1 Support Reactive Programming (Reactor/WebFlux)",id:"91-support-reactive-programming-reactorwebflux",level:3},{value:"9.2 Integrate Spring Cloud Sleuth",id:"92-integrate-spring-cloud-sleuth",level:3},{value:"9.3 Support OpenTelemetry",id:"93-support-opentelemetry",level:3},{value:"10. Summary",id:"10-summary",level:2}];function p(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"jaeger-trace-mdc",children:"Jaeger Trace MDC"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://github.com/Halcyon666/learn-cases/tree/main/learncases/src/main/java/com/whalefall/learncases/tracer",children:"Simple Demo Code"})}),"\n",(0,t.jsx)(n.h2,{id:"1-solution-overview",children:"1. Solution Overview"}),"\n",(0,t.jsx)(n.h3,{id:"11-background-and-objectives",children:"1.1 Background and Objectives"}),"\n",(0,t.jsx)(n.p,{children:"In distributed systems, cross-service request link tracing is a key means of locating problems. This solution aims to implement deep integration of Jaeger distributed tracing and SLF4J MDC (Mapped Diagnostic Context), enabling:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Logs automatically carry traceId/spanId, facilitating log aggregation queries"}),"\n",(0,t.jsx)(n.li,{children:"Support cross-service trace context passing"}),"\n",(0,t.jsx)(n.li,{children:"Maintain trace context accuracy in asynchronous scenarios like thread pools"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"12-core-value",children:"1.2 Core Value"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Problem Location Efficiency Improvement"}),": Quickly correlate all relevant logs in distributed systems via traceId"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Zero Intrusiveness"}),": Business code does not need to manually manage MDC, automatic injection and cleanup"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Thread Safety"}),": Support nested Spans and thread pool reuse scenarios"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"2-architecture-design",children:"2. Architecture Design"}),"\n",(0,t.jsx)(n.h3,{id:"21-overall-architecture-diagram",children:"2.1 Overall Architecture Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Application Layer                        \u2502\n\u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 Controller   \u2502\u2500\u2500\u2500>\u2502  Service     \u2502\u2500\u2500\u2500>\u2502   DAO        \u2502  \u2502\n\u2502  \u2502 (HTTP Entry) \u2502    \u2502 (Business)   \u2502    \u2502 (Database)   \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502         \u2502                    \u2502                    \u2502          \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502                              \u2502                                \u2502\n47: \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502          Tracing Layer       \u25BC                                \u2502\n\u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502     CustomMDCScopeManager (Core Component)    \u2502           \u2502\n\u2502  \u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502           \u2502\n\u2502  \u2502  \u2502  ThreadLocal<CustomMDCScope>        \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - Manage Scope Lifecycle           \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - Maintain Span Stack              \u2502     \u2502           \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502           \u2502\n\u2502  \u2502                                               \u2502           \u2502\n\u2502  \u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502           \u2502\n\u2502  \u2502  \u2502  CustomMDCScope (Scope Impl)        \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - MDC Snapshot and Restore         \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  - Support Nested Span              \u2502     \u2502           \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                              \u2502                                \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Logging Layer        \u25BC                                \u2502\n\u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502              SLF4J MDC                        \u2502           \u2502\n\u2502  \u2502  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502           \u2502\n\u2502  \u2502  \u2502  traceId:  04bf92f3577b34da...      \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  spanId:   36bd32b7a5712a1a         \u2502     \u2502           \u2502\n\u2502  \u2502  \u2502  parentId: 00f067aa0ba902b7         \u2502     \u2502           \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                              \u2502                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u25BC\n                    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502  Jaeger Collector  \u2502\n                    \u2502  (Trace Storage)   \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.h3,{id:"22-core-component-description",children:"2.2 Core Component Description"}),"\n",(0,t.jsx)(n.h4,{id:"221-custommdcscopemanager",children:"2.2.1 CustomMDCScopeManager"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Responsibilities"}),": Implement OpenTracing's ",(0,t.jsx)(n.code,{children:"ScopeManager"})," interface, manage Span activation and propagation"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Key Implementation"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"private final ThreadLocal<CustomMDCScope> tlsScope = new ThreadLocal<>();\n\n@Override\npublic Scope activate(Span span) {\n    return new CustomMDCScope(span);\n}\n\n@Override\npublic Span activeSpan() {\n    CustomMDCScope scope = tlsScope.get();\n    return scope == null ? null : scope.wrapped;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Design Points"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Use ",(0,t.jsx)(n.code,{children:"ThreadLocal"})," to ensure thread isolation"]}),"\n",(0,t.jsx)(n.li,{children:"Support Scope nesting (maintain previous through linked list structure)"}),"\n",(0,t.jsxs)(n.li,{children:["Implement lazy activation: Inject MDC only when calling ",(0,t.jsx)(n.code,{children:"activate()"})]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"222-custommdcscope",children:"2.2.2 CustomMDCScope"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Responsibilities"}),": Implement OpenTracing's ",(0,t.jsx)(n.code,{children:"Scope"})," interface, manage single Span lifecycle"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Core Mechanism"}),": Snapshot-Inject-Restore"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'CustomMDCScope(Span span) {\n    // 1. Save current MDC snapshot\n    this.previousTraceId = MDC.get("traceId");\n    this.previousSpanId = MDC.get("spanId");\n    \n    // 2. Establish linked list relationship (support nesting)\n    this.previous = CustomMDCScopeManager.this.tlsScope.get();\n    CustomMDCScopeManager.this.tlsScope.set(this);\n    \n    // 3. Inject new trace context\n    MDC.put("traceId", span.context().toTraceId());\n    MDC.put("spanId", span.context().toSpanId());\n}\n\n@Override\npublic void close() {\n    // 4. Restore to previous Scope\n    CustomMDCScopeManager.this.tlsScope.set(previous);\n    \n    // 5. Restore MDC to snapshot state\n    restoreMDC("traceId", previousTraceId);\n    restoreMDC("spanId", previousSpanId);\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"3-key-process-design",children:"3. Key Process Design"}),"\n",(0,t.jsx)(n.h3,{id:"31-process-of-receiving-remote-trace-context",children:"3.1 Process of Receiving Remote Trace Context"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 HTTP Request\u2502\n\u2502  Headers    \u2502\n\u2502 uber-trace-id: 4bf92f3577b...\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. Parse HTTP Header             \u2502\n\u2502    - Extract traceId (128-bit)   \u2502\n\u2502    - Extract parentSpanId (64-bit)\u2502\n\u2502    - Extract flags (Sample Tag)  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. Construct JaegerSpanContext   \u2502\n\u2502    long[] parts = splitTraceId() \u2502\n\u2502    new JaegerSpanContext(        \u2502\n\u2502      traceIdHigh,                \u2502\n\u2502      traceIdLow,                 \u2502\n\u2502      parentSpanId,               \u2502\n\u2502      parentOfParentId,           \u2502\n\u2502      flags                       \u2502\n\u2502    )                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. Create Child Span             \u2502\n\u2502    tracer.buildSpan("child-span")\u2502\n\u2502          .asChildOf(parentContext)\u2502\n\u2502          .withTag(...)           \u2502\n\u2502          .start()                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. Activate Span to Current Thread\u2502\n\u2502    try (Scope scope =            \u2502\n\u2502      tracer.scopeManager()       \u2502\n\u2502            .activate(childSpan)) \u2502\n\u2502    {                             \u2502\n\u2502      // MDC Auto Injection       \u2502\n\u2502      // Business Logic Execution \u2502\n\u2502    } // MDC Auto Cleanup         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,t.jsx)(n.h3,{id:"32-mdc-management-process-for-nested-spans",children:"3.2 MDC Management Process for Nested Spans"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'Timeline \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\n\nThreadLocal Stack:\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  null                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nactivate(spanA)\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  ScopeA: {traceId: xxx, spanId: A, previous: null}\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nMDC: {traceId: xxx, spanId: A}\n\n  activate(spanB)  // Nested Call\n  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  ScopeB: {traceId: xxx, spanId: B, previous: ScopeA}\u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n  MDC: {traceId: xxx, spanId: B}  // spanId Update\n\n    // Business Code Execution\n    log.info("Processing...")  // Log carries spanId=B\n\n  close(ScopeB)\n  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  ScopeA: {traceId: xxx, spanId: A, previous: null}\u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n  MDC: {traceId: xxx, spanId: A}  // Restore to spanId=A\n\nclose(ScopeA)\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  null                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nMDC: {}  // Completely Clear\n'})}),"\n",(0,t.jsx)(n.h3,{id:"33-trace-id-split-algorithm",children:"3.3 Trace ID Split Algorithm"}),"\n",(0,t.jsxs)(n.p,{children:["Jaeger supports 128-bit traceId, but Java ",(0,t.jsx)(n.code,{children:"long"})," is only 64-bit, so splitting is required:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'/**\n * Split hexadecimal traceId string into high 64 bits and low 64 bits\n * \n * Example:\n * Input: "04bf92f3577b34da63ce929d0e0e4736" (32 hex characters = 128 bit)\n * Output: [0x04bf92f3577b34da, 0x63ce929d0e0e4736]\n */\npublic static long[] splitTraceId(String traceIdHex) {\n    if (traceIdHex.length() <= 16) {\n        // Only low 64 bits, high bits are 0\n        return new long[]{0L, parseLong(traceIdHex)};\n    } else {\n        // Split into high 64 bits and low 64 bits\n        String highHex = traceIdHex.substring(0, traceIdHex.length() - 16);\n        String lowHex = traceIdHex.substring(traceIdHex.length() - 16);\n        return new long[]{parseLong(highHex), parseLong(lowHex)};\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"4-configuration-and-integration",children:"4. Configuration and Integration"}),"\n",(0,t.jsx)(n.h3,{id:"41-tracer-initialization-configuration",children:"4.1 Tracer Initialization Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'static Tracer tracer = new Configuration("order-service")\n    .withSampler(\n        new Configuration.SamplerConfiguration()\n            .withType("const")\n            .withParam(1)  // Sampling Rate 100%\n    )\n    .withReporter(\n        new Configuration.ReporterConfiguration()\n            .withLogSpans(true)  // Enable log output in development environment\n            .withSender(\n                new Configuration.SenderConfiguration()\n                    .withAgentHost("localhost")\n                    .withAgentPort(6831)\n            )\n    )\n    .getTracerBuilder()\n    .withScopeManager(new CustomMDCScopeManager())  // Key: Inject Custom Manager\n    .build();\n'})}),"\n",(0,t.jsx)(n.h3,{id:"42-logback-configuration",children:"4.2 Logback Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<configuration>\n    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">\n        <encoder>\n            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} [traceId=%X{traceId} spanId=%X{spanId}] - %msg%n</pattern>\n        </encoder>\n    </appender>\n    \n    <appender name="JSON" class="ch.qos.logback.core.FileAppender">\n        <file>logs/app.json</file>\n        <encoder class="net.logstash.logback.encoder.LogstashEncoder">\n            <includeMdcKeyName>traceId</includeMdcKeyName>\n            <includeMdcKeyName>spanId</includeMdcKeyName>\n            <includeMdcKeyName>parentId</includeMdcKeyName>\n        </encoder>\n    </appender>\n    \n    <root level="INFO">\n        <appender-ref ref="CONSOLE" />\n        <appender-ref ref="JSON" />\n    </root>\n</configuration>\n'})}),"\n",(0,t.jsx)(n.h3,{id:"43-spring-boot-integration-optional",children:"4.3 Spring Boot Integration (Optional)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class TracingConfig {\n    \n    @Bean\n    public Tracer jaegerTracer() {\n        return new Configuration(\n                env.getProperty("spring.application.name", "unknown-service")\n            )\n            .withSampler(samplerConfig())\n            .withReporter(reporterConfig())\n            .getTracerBuilder()\n            .withScopeManager(new CustomMDCScopeManager())\n            .build();\n    }\n    \n    @Bean\n    public TracingFilter tracingFilter(Tracer tracer) {\n        return new TracingFilter(tracer);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"5-usage-scenarios-and-best-practices",children:"5. Usage Scenarios and Best Practices"}),"\n",(0,t.jsx)(n.h3,{id:"51-receive-upstream-trace-context",children:"5.1 Receive Upstream Trace Context"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@RestController\npublic class OrderController {\n    \n    @GetMapping("/order/{id}")\n    public Order getOrder(\n        @PathVariable String id,\n        @RequestHeader(value = "uber-trace-id", required = false) String uberTraceId\n    ) {\n        JaegerSpanContext parentContext = parseUberTraceId(uberTraceId);\n        \n        Span span = tracer.buildSpan("get-order")\n            .asChildOf(parentContext)  // Key: Link Remote Parent Span\n            .withTag(Tags.SPAN_KIND, Tags.SPAN_KIND_SERVER)\n            .withTag("order.id", id)\n            .start();\n        \n        try (Scope scope = tracer.scopeManager().activate(span)) {\n            log.info("Processing order request");  // Automatically carries traceId/spanId\n            return orderService.getById(id);\n        } finally {\n            span.finish();\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"52-pass-trace-context-downstream",children:"5.2 Pass Trace Context Downstream"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class PaymentClient {\n    \n    public void processPayment(String orderId) {\n        Span span = tracer.buildSpan("call-payment-service")\n            .withTag(Tags.SPAN_KIND, Tags.SPAN_KIND_CLIENT)\n            .start();\n        \n        try (Scope scope = tracer.scopeManager().activate(span)) {\n            HttpHeaders headers = new HttpHeaders();\n            \n            // Inject trace context to HTTP Header\n            tracer.inject(\n                span.context(),\n                Format.Builtin.HTTP_HEADERS,\n                new HttpHeadersCarrier(headers)\n            );\n            \n            restTemplate.exchange(\n                "http://payment-service/pay",\n                HttpMethod.POST,\n                new HttpEntity<>(paymentRequest, headers),\n                PaymentResponse.class\n            );\n        } finally {\n            span.finish();\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"53-async-scenario-handling",children:"5.3 Async Scenario Handling"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Service\npublic class AsyncOrderService {\n    \n    @Autowired\n    private Tracer tracer;\n    \n    @Autowired\n    private ExecutorService executorService;\n    \n    public void processOrderAsync(String orderId) {\n        Span parentSpan = tracer.activeSpan();  // Get Current Span\n        \n        executorService.submit(() -> {\n            // Reactivate Parent Span in New Thread\n            Span asyncSpan = tracer.buildSpan("async-process")\n                .asChildOf(parentSpan)\n                .start();\n            \n            try (Scope scope = tracer.scopeManager().activate(asyncSpan)) {\n                log.info("Async processing order");  // MDC Correctly Injected\n                // Business Logic\n            } finally {\n                asyncSpan.finish();\n            }\n        });\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"6-key-design-decisions",children:"6. Key Design Decisions"}),"\n",(0,t.jsx)(n.h3,{id:"61-why-not-operate-mdc-directly-in-business-code",children:"6.1 Why not operate MDC directly in business code?"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Problem"}),": Manual management is easy to miss cleanup, leading to traceId pollution during thread pool reuse."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution"}),": Through ScopeManager lifecycle management, inject at ",(0,t.jsx)(n.code,{children:"activate()"})," and automatically clean up at ",(0,t.jsx)(n.code,{children:"close()"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"62-why-need-to-save-mdc-snapshot",children:"6.2 Why need to save MDC snapshot?"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Scenario"}),": When nested Span calls, need to restore parent Span's MDC after child Span ends."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Implementation"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// When entering child Span\nthis.previousTraceId = MDC.get("traceId");  // Save snapshot\nMDC.put("traceId", childSpan.context().toTraceId());  // Overwrite\n\n// When exiting child Span\nrestoreMDC("traceId", previousTraceId);  // Restore snapshot\n'})}),"\n",(0,t.jsx)(n.h3,{id:"63-why-use-threadlocal-instead-of-inheritablethreadlocal",children:"6.3 Why use ThreadLocal instead of InheritableThreadLocal?"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Consideration"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"ThreadLocal"}),": Strict thread isolation, suitable for synchronous scenarios"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"InheritableThreadLocal"}),": Child thread inherits parent thread values, but context leakage is prone to occur during thread pool reuse"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Recommendation"}),": Explicitly pass Span in asynchronous scenarios, rather than relying on automatic inheritance"]}),"\n",(0,t.jsx)(n.h2,{id:"7-monitoring-and-debugging",children:"7. Monitoring and Debugging"}),"\n",(0,t.jsx)(n.h3,{id:"71-log-output-example",children:"7.1 Log Output Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"21:45:32.123 [http-nio-8080-exec-1] INFO  c.w.OrderService [traceId=04bf92f3577b34da63ce929d0e0e4736 spanId=36bd32b7a5712a1a] - Processing order ORD-001\n21:45:32.234 [http-nio-8080-exec-1] INFO  c.w.PaymentClient [traceId=04bf92f3577b34da63ce929d0e0e4736 spanId=7f3a28b9c4d5e6a1] - Calling payment service\n21:45:32.456 [http-nio-8080-exec-1] INFO  c.w.OrderService [traceId=04bf92f3577b34da63ce929d0e0e4736 spanId=36bd32b7a5712a1a] - Order processed successfully\n"})}),"\n",(0,t.jsx)(n.h3,{id:"72-jaeger-ui-query",children:"7.2 Jaeger UI Query"}),"\n",(0,t.jsx)(n.p,{children:"In Jaeger UI you can:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["View complete call chain via traceId ",(0,t.jsx)(n.code,{children:"04bf92f3577b34da63ce929d0e0e4736"})]}),"\n",(0,t.jsxs)(n.li,{children:["View each Span's Tags (such as ",(0,t.jsx)(n.code,{children:"db.statement"}),", ",(0,t.jsx)(n.code,{children:"http.status_code"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"View parent-child relationship and time consumption distribution between Spans"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"73-common-troubleshooting",children:"7.3 Common Troubleshooting"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Problem Phenomenon"}),(0,t.jsx)(n.th,{children:"Possible Cause"}),(0,t.jsx)(n.th,{children:"Troubleshooting Method"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"traceId is empty in log"}),(0,t.jsx)(n.td,{children:"Span not activated or ScopeManager not configured correctly"}),(0,t.jsxs)(n.td,{children:["Check ",(0,t.jsx)(n.code,{children:"activate()"})," call and Tracer construction"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"traceId crosstalk between different requests"}),(0,t.jsx)(n.td,{children:"MDC not cleaned up correctly (thread pool reuse)"}),(0,t.jsxs)(n.td,{children:["Ensure ",(0,t.jsx)(n.code,{children:"MDC.remove()"})," called in ",(0,t.jsx)(n.code,{children:"finally"})," block"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Child Span not linked to Parent Span"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"asChildOf()"})," parameter error"]}),(0,t.jsx)(n.td,{children:"Verify if parentSpanId is parsed correctly"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Span not visible in Jaeger"}),(0,t.jsx)(n.td,{children:"Sampling rate set to 0 or Reporter configuration error"}),(0,t.jsxs)(n.td,{children:["Check ",(0,t.jsx)(n.code,{children:"withParam(1)"})," and network connectivity"]})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"8-performance-considerations",children:"8. Performance Considerations"}),"\n",(0,t.jsx)(n.h3,{id:"81-performance-impact-analysis",children:"8.1 Performance Impact Analysis"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Operation"}),(0,t.jsx)(n.th,{children:"Time Consumption"}),(0,t.jsx)(n.th,{children:"Impact"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"MDC.put()"}),(0,t.jsx)(n.td,{children:"< 1\u03BCs"}),(0,t.jsx)(n.td,{children:"Negligible"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"ThreadLocal.get()"}),(0,t.jsx)(n.td,{children:"< 1\u03BCs"}),(0,t.jsx)(n.td,{children:"Negligible"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Span.start()"}),(0,t.jsx)(n.td,{children:"~10\u03BCs"}),(0,t.jsx)(n.td,{children:"Low"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Span.finish() + Report"}),(0,t.jsx)(n.td,{children:"~100\u03BCs"}),(0,t.jsx)(n.td,{children:"Async reporting, small impact on main flow"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"82-optimization-suggestions",children:"8.2 Optimization Suggestions"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reasonable control of sampling rate"}),": Production environment can be set to 0.1 (10%) to reduce storage costs"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Batch reporting"}),": Reporter configuration ",(0,t.jsx)(n.code,{children:"withFlushInterval(1000)"})," batch send Spans"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Avoid excessive Spans"}),": Do not create Span for every database query, control granularity"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"9-extension-directions",children:"9. Extension Directions"}),"\n",(0,t.jsx)(n.h3,{id:"91-support-reactive-programming-reactorwebflux",children:"9.1 Support Reactive Programming (Reactor/WebFlux)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class ReactorScopeManager implements ScopeManager {\n    @Override\n    public Scope activate(Span span) {\n        return new ReactorScope(span);\n    }\n    \n    static class ReactorScope implements Scope {\n        ReactorScope(Span span) {\n            // Use Reactor Context instead of ThreadLocal\n            Context.of("span", span);\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"92-integrate-spring-cloud-sleuth",children:"9.2 Integrate Spring Cloud Sleuth"}),"\n",(0,t.jsx)(n.p,{children:"Spring Cloud Sleuth provides out-of-the-box distributed tracing, can replace this solution:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-sleuth</artifactId>\n</dependency>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"93-support-opentelemetry",children:"9.3 Support OpenTelemetry"}),"\n",(0,t.jsx)(n.p,{children:"OpenTelemetry is the new generation observability standard, migration is recommended in the future:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"OpenTelemetry openTelemetry = AutoConfiguredOpenTelemetrySdk\n    .initialize()\n    .getOpenTelemetrySdk();\n"})}),"\n",(0,t.jsx)(n.h2,{id:"10-summary",children:"10. Summary"}),"\n",(0,t.jsxs)(n.p,{children:["This solution implements seamless integration of Jaeger Trace and SLF4J MDC through custom ",(0,t.jsx)(n.code,{children:"ScopeManager"}),", with the following features:"]}),"\n",(0,t.jsxs)(n.p,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Automation"}),": Scope lifecycle management, no need to manually operate MDC\n\u2705 ",(0,t.jsx)(n.strong,{children:"Thread Safety"}),": ThreadLocal isolation + Snapshot recovery mechanism\n\u2705 ",(0,t.jsx)(n.strong,{children:"Nesting Support"}),": Linked list structure maintains multi-layer Span relationship\n\u2705 ",(0,t.jsx)(n.strong,{children:"Production Ready"}),": Considered boundary conditions such as thread pool reuse, asynchronous scenarios"]}),"\n",(0,t.jsx)(n.p,{children:"This solution is suitable for microservice architectures requiring fine-grained control of trace context propagation, especially scenarios such as service gateways and BFF layers that need to receive upstream trace information."}),"\n","\n",(0,t.jsx)(s.A,{})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}}}]);